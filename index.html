<!DOCTYPE html>

<html data-theme="dark" lang="en">
<head>
<link href="favicon.png" rel="icon" type="image/png"/>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>ARK Trades – Dashboard </title>
<style>
@media (prefers-color-scheme: dark) {
  input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); }
}

/* ===== Modern theme tokens ===== */
:root {
  --bg: #090812; /* SFONDO DARK PROFONDO 🟪 */ /* SFONDO DARK NEUTRO 🟪 */
  --bg-grad: radial-gradient(150vmax 80vmax at -10% -20%, rgba(124,58,237,0.14), transparent 60%),
             radial-gradient(120vmax 70vmax at 110% -25%, rgba(88,28,135,0.10), transparent 65%),
             #090812; /* GRADIENTE VIOLA ARK SCURO 🟪 */
  --panel: rgba(14,11,22,0.94); /* PANNELLO DARK VIOLA INTENSO 🟪 */ /* PANNELLO DARK VIOLA 🟪 */ /* PANNELLO VIOLA SCURO 🟪 */
  --ink: #e8eaee;
  --muted: #b5bfd3; /* TESTO SECONDARIO PIÙ CHIARO 🟪 */
  --line: rgba(198,138,255,0.38); /* brighter line violet */ /* LINEA/CONFINI VIOLA SCURO 🟪 */ /* LINEA/CONFINI VIOLA 🟪 */
  --accent: #7c3aed; /* VIOLA ARK SCURO 🟪 */ /* VIOLA ARK PIÙ LUMINOSO 🟪 */ /* VIOLA ARK 🟪 */
  --accent-ink: #0d0716; /* TESTO SU VIOLA SCURO 🟪 */ /* TESTO SU VIOLA LUMINOSO 🟪 */ /* TESTO SU VIOLA ARK 🟪 */
  --green:#22c55e;
  --red:#f43f5e;
  --chip: #0f0a17; /* CHIP VIOLA SCURO 🟪 */ /* CHIP VIOLA 🟪 */
  --chip-on:#e8eaee;
  --chip-on-ink:#0b0d10;
  --pill-bg: #110b1b; /* PILL BACKGROUND VIOLA SCURO 🟪 */ /* PILL BACKGROUND VIOLA 🟪 */
  --shadow: 0 12px 32px rgba(0,0,0,.35);
  --radius: 16px;
}
[data-theme="light"] {
  --bg: #090812; /* SFONDO DARK PROFONDO 🟪 */ /* SFONDO DARK NEUTRO 🟪 */
  --bg-grad: radial-gradient(150vmax 80vmax at -10% -20%, rgba(124,58,237,0.14), transparent 60%),
             radial-gradient(120vmax 70vmax at 110% -25%, rgba(88,28,135,0.10), transparent 65%),
             #090812; /* GRADIENTE VIOLA ARK SCURO 🟪 */
  --panel: rgba(14,11,22,0.94); /* PANNELLO DARK VIOLA INTENSO 🟪 */ /* PANNELLO DARK VIOLA 🟪 */ /* PANNELLO VIOLA SCURO 🟪 */
  --ink:#0c1220;
  --muted: #b5bfd3; /* TESTO SECONDARIO PIÙ CHIARO 🟪 */
  --line: rgba(124,58,237,0.22); /* LINEA/CONFINI VIOLA SCURO 🟪 */ /* LINEA/CONFINI VIOLA 🟪 */
  --accent:#111;
  --accent-ink:#fff;
  --chip: #0f0a17; /* CHIP VIOLA SCURO 🟪 */ /* CHIP VIOLA 🟪 */
  --chip-on:#111;
  --chip-on-ink:#fff;
  --pill-bg: #110b1b; /* PILL BACKGROUND VIOLA SCURO 🟪 */ /* PILL BACKGROUND VIOLA 🟪 */
  --shadow: 0 10px 24px rgba(0,0,0,.08);
}

/* ===== Base ===== */
html,body{
  margin:0;padding:0;
  background: var(--bg-grad);
  color:var(--ink);
  font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial, sans-serif;
}
.container{max-width:1250px;margin:0 auto;padding:24px}
h1{font-size:22px;margin:0 0 4px; letter-spacing:.2px}
p.note{color:var(--muted);font-size:13px;margin:6px 0 18px}

/* ===== Cards ===== */
.card{
  background:var(--panel);
  border:1px solid var(--line);
  border-radius:var(--radius);
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
}
.card.pad{padding:16px}

/* ===== Grid ===== */
.grid{display:grid;gap:8px}
.grid.fit-240{grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
.grid.two-col{grid-template-columns:2fr 1fr}
@media (max-width:1100px){ .grid.two-col{grid-template-columns:1fr} }

/* ===== Labels / Inputs ===== */
label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}

input[type="date"],
input[type="text"] {
  width: 80%;
  padding: 12px 12px;
  border: 1px solid var(--line);
  border-radius: 12px;
  font-size: 14px;
  outline: none;
  background: rgba(124,58,237,0.08); /* subtle violet tint */
  color: var(--ink);
  transition: box-shadow .2s, border-color .2s;
}
input[type="date"]:focus, input[type="text"]:focus { border-color: rgba(139,92,246,0.6); box-shadow: 0 0 0 4px rgba(139,92,246,0.15); } /* FOCUS VIOLA ARK 🟪 */
input::placeholder{color:var(--muted)}

/* 👇 limiti confermati */
input[type="date"] { max-width: 235px; }
input[type="text"] { max-width: 235px; }

input[type="checkbox"]{transform:scale(1.05);margin-right:6px}

/* ===== Buttons ===== */
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn{
  background:transparent;
  border:1px solid var(--line);
  border-radius:999px;
  padding:10px 14px;
  font-size:14px;
  cursor:pointer;
  color:var(--ink);
  transition: border-color .2s, box-shadow .2s, transform .05s;
}
.btn:hover{box-shadow:0 6px 18px rgba(0,0,0,.25);border-color:#2a313a}
.btn:active{transform: translateY(1px)}
.btn.primary{
  background:var(--accent);
  border-color:var(--accent);
  color:var(--accent-ink);
   /* OMBRA BOTTONE VIOLA ARK LUMINOSO 🟪 */
}

/* ===== Chips ===== */
.chips{display:flex;flex-wrap:nowrap;gap:8px;overflow-x:auto}
.chip{
  border:1px solid var(--line);
  border-radius:999px;
  padding:7px 12px;
  font-size:13px;
  background:var(--chip);
  color:var(--ink);
  cursor:pointer;
  transition: background .2s, color .2s, border-color .2s;
  white-space:nowrap;
}
.chip.on{
  background: var(--accent);
  color: #fff;
  border-color: transparent;
  position: relative;
  z-index: 1;
  background-clip: padding-box;
  /* glow più naturale e non "stirato": blur con spread negativo */
  box-shadow:
    0 0 0 1px rgba(255,255,255,0.06) inset,
    0 8px 16px -6px rgba(124,58,237,0.55);
} /* CHIP ATTIVO VIOLA GLOW (TIGHT) 🟪 */ /* CHIP ATTIVO VIOLA GLOW 🟪 */ /* CHIP ATTIVO VIOLA 🟪 */

/* ===== Table ===== */
table{border-collapse:collapse;width:100%;font-size:14px;table-layout:fixed}
thead{background:linear-gradient(180deg, rgba(124,58,237,.10), rgba(124,58,237,.03));
  border-bottom:1px solid var(--line)
}
[data-theme="light"] thead{background:linear-gradient(180deg, rgba(124,58,237,.10), rgba(124,58,237,.03));text-align:left;border-top:1px solid var(--line);vertical-align:middle}
td.num{text-align:right;padding-right:10px}
tr:hover{background:rgba(255,255,255,.03)}
.buy{color:var(--green);font-weight:700}
.sell{color:var(--red);font-weight:700}
.muted{color:var(--muted)}
.right{margin-left:auto}
.stat .label{font-size:12px;color:var(--muted)}
.stat .value{font-size:16px;font-weight:600}
.stat{max-width:160px;flex:1}

/* ===== Footer / misc ===== */
.footer{font-size:12px;color:var(--muted);margin-top:16px}
.stats-funds-grid{display:grid;grid-template-columns:auto auto 1fr;gap:12px}
.follow-btn{background:transparent;border:none;cursor:pointer;color:var(--muted);font-size:14px;margin-left:4px}
.follow-btn:hover{color:var(--accent)}
#suggestions div{padding:4px 8px;cursor:pointer}
#suggestions div:hover{background:var(--line)}

.controls .card{min-width:0}
.date-card{max-width:190px}
.search-card{max-width:none;position:relative;width:100%;min-width:0}

.ticker-pill{
  display:inline-block;padding:4px 10px;border-radius:999px;font-weight:700;letter-spacing:.2px;
  background:var(--pill-bg);
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
}
.ticker-link{cursor:pointer;text-decoration:none}
.ticker-link:hover{opacity:.95}

.overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:20px}
.overlay .panel{background:var(--panel);border:1px solid var(--line);border-radius:16px;max-width:600px;width:100%;max-height:85vh;overflow:auto;box-shadow:var(--shadow)}
.overlay .panel .hdr{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid var(--line)}
.overlay .panel .body{padding:12px 16px}
.close{margin-left:auto}

.btn.on{background:var(--ink);color:var(--chip-on-ink);border-color:var(--ink)}
#suggestions{box-shadow:0 10px 30px rgba(0,0,0,.45)}

/* ===== Mobile polish (v2) ===== */
@media (max-width: 600px){
  .container{padding:12px}
  section{margin-bottom:14px}
  h1{font-size:18px;line-height:1.2}
  h2{font-size:16px;line-height:1.2}
  label{font-size:13px}
  .controls.grid{gap:10px}
  .controls.grid.fit-240{grid-template-columns:1fr}
  .card.pad{padding:12px}
  .date-card, .search-card{max-width:100%; width:100%}
  input[type="date"], input[type="text"], select, button{
    width:100%; max-width:100%; font-size:14px; box-sizing:border-box;
  }
  .chips{flex-wrap:wrap; overflow:visible; gap:8px}
}
@media (max-width: 600px){
  #table{table-layout:auto; font-size:13px}
  #table th, #table td{padding:8px 10px}
  #table colgroup col{width:auto !important}
  #table td a .muted, #table td, #table th{white-space:normal; word-break:break-word}
  .ticker-pill{font-size:11px; padding:4px 8px}
}
@media (max-width: 420px){
  .ticker-pill{font-size:10px; padding:3px 6px}
  #table{font-size:12px}
  .grid.fit-240{grid-template-columns:1fr}
  #table thead th:nth-child(2),
  #table tbody td:nth-child(2),
  #table thead th:nth-child(4),
  #table tbody td:nth-child(4){display:none}
}

/* Link icon beside ticker */
.ticker-pill.gf-open{cursor:pointer} .name-open{cursor:pointer}
.icon-link{
  display:inline-flex;align-items:center;justify-content:center;
  margin-left:6px;padding:2px 4px;border:none;background:transparent;cursor:pointer;
  color:var(--muted); opacity:.9;
  transition: opacity .2s, transform .05s;
}
.icon-link:hover{opacity:1; transform: translateY(-1px);}

/* === Patches v3.7 === */
.overlay{background:rgba(0,0,0,.65)!important}
.overlay .panel{background:#111418!important; backdrop-filter:none!important}
/* Right-align Shares header */
th.num{ text-align:right !important; }
/* Slightly tighter table cell spacing */
th,td{ padding:10px 12px; }

/* === v3.8 patches === */
.overlay .panel table th, 
.overlay .panel table td {
  padding: 8px 10px !important;
}
.overlay .panel table colgroup col:nth-child(4) {
  width: 70px !important;
}
.buy .arrow { color: var(--green); }
.sell .arrow { color: var(--red); }

/* === v3.9 patches === */
/* Make the search card host the buttons nicely on one line when space allows */
@media (min-width: 721px){
  .search-card .row { justify-content: flex-start; }
}
/* Overlay table tighter and defined column widths */
.overlay .panel table{ table-layout: fixed; width: 100%; }
.overlay .panel table th, .overlay .panel table td{ padding: 6px 8px !important; }

.buy .arrow { color: var(--green); } .sell .arrow { color: var(--red); }

/* === v3.10 patches === */
.overlay .panel table{ table-layout: fixed; width: 100%; }
.overlay .panel table th, .overlay .panel table td{ padding: 6px 6px !important; } /* tighter */

/* === v3.11 patches === */
/* Merge UI: if any empty control cards remain, hide them */
.controls > .card.pad:empty { display:none; }
.search-card{ position:relative; z-index: 20; }
#suggestions{ position:absolute !important; z-index: 10000 !important; }

/* === v3.11b patches === */
/* Suggestions popup: solid background (no transparency/blur) and strong stacking */
#suggestions {
  background: #111418 !important;
  border: 1px solid var(--line) !important;
  backdrop-filter: none !important;
  z-index: 10000 !important;
}
.search-card { position: relative; z-index: 2000; }

/* Inline layout: search input + buttons on the same row */
.search-inline {
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: nowrap;
}
.search-inline input[type="text"] {
  flex: 1 1 auto;
  max-width: 100% !important;
}
@media (max-width: 800px){
  .search-inline { flex-wrap: wrap; }
  .search-inline button { width: auto; }
}


/* === Controls row fix (v3.11b → v3.11b-fixed) === */
section.controls{
  display:grid !important;
  grid-template-columns: 250px 250px 1fr !important; /* From | To | Search */
  column-gap: 10px !important;
  row-gap: 0 !important;
}
@media (max-width: 900px){
  section.controls{ grid-template-columns: 1fr !important; row-gap: 10px !important; }
}

/* Keep search input + buttons inline and wide */
.search-inline{ display:flex; gap:12px; align-items:center; flex-wrap:nowrap; }
.search-inline input[type="text"]{ flex:1 1 auto !important; max-width:100% !important; width:100% !important; min-width:0 !important; }

/* Suggestions solid and on top */
#suggestions{ position:absolute !important; z-index: 30000 !important; background:#111418 !important; border:1px solid var(--line) !important; backdrop-filter:none !important; box-shadow:0 14px 40px rgba(0,0,0,.5); }

/* === v3.11b-fixed.1: tighten gaps + prevent right overflow === */
section.controls{
  box-sizing: border-box !important;
  width: 100% !important;
  display: grid !important;
  grid-template-columns: 250px 250px minmax(0, 1fr) !important; /* dates wider + search fills leftover safely */
  column-gap: 6px !important;  /* close the gap a bit more */
  row-gap: 0 !important;
  align-items: stretch !important;
}
.search-card{ max-width: none !important; width: 100% !important; min-width: 0 !important; overflow: hidden; }
.search-inline{ display:flex !important; gap:12px; align-items:center; flex-wrap:nowrap; min-width:0 !important; }
.search-inline input[type="text"]{ flex:1 1 auto !important; min-width:0 !important; width:100% !important; }
.search-inline .btn{ white-space:nowrap; }

/* Defensive: cards should not exceed grid cell */
section.controls > .card.pad{ overflow: hidden; }

/* === v3.11b-fixed.2: no-overflow & balanced columns === */
.wrap{ overflow-x: hidden; } /* safety net, but columns below should remove the need */

section.controls{
  display: grid !important;
  /* responsive, never overflow: two min widths for dates, search fills leftover */
  grid-template-columns: minmax(240px, 1fr) minmax(240px, 1fr) minmax(0, 1.6fr) !important;
  column-gap: 8px !important;
  row-gap: 0 !important;
  box-sizing: border-box !important;
  width: 100% !important;
}
/* remove any margins that could push the last card */
section.controls > .card.pad{ margin: 0 !important; max-width: 100% !important; overflow: hidden; }
.search-card{ max-width: 100% !important; width: 100% !important; min-width: 0 !important; }
.search-inline{ display:flex !important; gap:12px; align-items:center; flex-wrap:nowrap; min-width:0; }
.search-inline input[type="text"]{ flex:1 1 auto !important; width:100% !important; min-width:0 !important; }

/* === v3.11b-fixed.3: eliminate right overflow for search chip === */
section.controls {
  padding-right: 0 !important;
  margin-right: 0 !important;
  overflow: hidden !important;
}
.search-card {
  width: calc(100% - 8px) !important;
  box-sizing: border-box !important;
  overflow: hidden !important;
}

/* === BG FIX: persistent non-repeating gradient layer (v3.11b-fixed.4) === */
/* Evita duplicazioni quando la pagina è corta e “perdita” del gradiente quando è lunga. */
html, body { background: none !important; } /* disattiva il background su html/body */
body::before{
  content:"";
  position: fixed;
  inset: 0;
  z-index: -1;
  pointer-events: none;
  background: var(--bg-grad);
  background-repeat: no-repeat;
  background-attachment: fixed;
  background-position: center;
  /* v* units garantiscono copertura oltre i bordi anche su schermi ultrawide */
  background-size: cover;
}


/* === OVERLAY THEME + Z-INDEX FIX (v3.11b-fixed.7) === */
/* Porta il pop-up sopra a tutto (chips/search incluse) e uniforma i colori al tema viola. */
.overlay{ 
  position: fixed; inset: 0; 
  background: rgba(0,0,0,.72) !important; 
  z-index: 50000 !important;  /* sopra a suggestions (30k) e search-card (2k) */
}
.overlay .panel{ 
  background: var(--panel) !important; 
  border: 1px solid var(--line) !important; 
  border-radius: 16px; 
  box-shadow: 0 20px 60px rgba(0,0,0,.45); 
  backdrop-filter: none !important;
  color: var(--ink);
}
.overlay .panel .hdr{ 
  border-bottom: 1px solid var(--line) !important; 
}
/* Pulsanti nell'overlay: coerenti con il viola */
.overlay .panel .btn.primary{ 
  background: var(--accent); 
  border-color: var(--accent); 
  color: #fff;
  
}
.overlay .panel .btn.on{ 
  background: var(--accent); color: #fff; border-color: var(--accent);
}
/* Tabella nel pop-up: bordi e hover coerenti */
.overlay .panel table thead{
  background: linear-gradient(180deg, rgba(124,58,237,.10), rgba(124,58,237,.03)) !important;
  border-bottom: 1px solid var(--line) !important;
}
.overlay .panel table th, 
.overlay .panel table td{ 
  border-top: 1px solid var(--line) !important;
}


/* === SUGGESTIONS FIX (v3.11b-fixed.8) === */
.search-card{ overflow: visible !important; } /* evita che il menu suggerimenti venga clippato */
#suggestions{ z-index: 40000 !important; background: var(--panel) !important; border: 1px solid var(--line) !important; }
/* arrotonda e aggiunge leggera ombra per coerenza */
#suggestions{ border-radius: 12px; box-shadow: 0 14px 40px rgba(0,0,0,.5); }


/* === SUGGESTIONS CLIP FIX v2 === */
/* Alcuni container avevano overflow:hidden; forziamo visibilità solo per la search-card. */
section.controls > .card.pad.search-card{ overflow: visible !important; }
.search-card{ overflow: visible !important; }
#suggestions{ z-index: 40000 !important; border-radius: 12px; box-shadow: 0 14px 40px rgba(0,0,0,.5); }


/* === SUGGESTIONS BODY-LEVEL DROPDOWN === */
#suggestions{ z-index: 60000 !important; pointer-events: auto !important; }


/* === TESTO CHIARO E GRASSETTO PER CHIP + REFRESH === */
.btn.primary,
.chip.on {
  color: #ffffff !important;       /* testo bianco */
  font-weight: 600 !important;     /* grassetto medio-forte */
}


/* === v4.1 UI polish === */
#csvBtn strong,
#goGFBtn strong,
#followBtn strong,
#closeOverlay strong { font-weight: 600; }
#followBtn.on { color: #fff !important; }


/* === v4.2 UI polish — ensure bold even when textContent changes === */
#csvBtn,
#goGFBtn,
#followBtn,
#closeOverlay { font-weight: 700 !important; }
#followBtn.on { color: #fff !important; }


/* === Checkbox styling — Only my tickers === */
#onlyMine {
  transform: scale(1.6);
  accent-color: var(--accent);
  cursor: pointer;
  margin-right: 8px;
}
label[for="onlyMine"],
label:has(#onlyMine) {
  font-weight: 600;
  color: var(--ink);
}


/* === v4.4 visuals — chip border pop + active field glow === */

/* Chips: brighter border, NO blur glow */
.chip {
  border-color: #c68aff !important; /* vivid purple */
  box-shadow: none !important;
}
.chip:hover {
  border-color: #d5aaff !important;
  box-shadow: none !important;
}

/* Active chips: keep very subtle depth without blur */
.chip.on {
  box-shadow:
    0 0 0 1px rgba(255,255,255,0.06) inset,
    0 8px 16px -10px rgba(124,58,237,0.55);
}

/* Inputs (date/search) focus: brighter ring + soft glow (kept) */
 (date/search) focus: brighter ring + soft blur glow */
input[type="date"]:focus,
input[type="text"]:focus,
select:focus,
textarea:focus{
  border-color:#e1c0ff !important;
  box-shadow:
    0 0 0 2px rgba(198,138,255,0.40),
    0 0 22px rgba(198,138,255,0.55);
  backdrop-filter: blur(2px);
  outline:none;
  transition: box-shadow .2s ease, border-color .2s ease;
}


/* === v4.6 — Restore neon effect for buttons (not chips) === */
.btn {
  position: relative;
}
.btn:hover,
.btn:focus,
.btn:focus-visible {
  border-color: #d5aaff !important;
  box-shadow:
    0 0 0 2px rgba(198,138,255,0.35),
    0 0 18px rgba(198,138,255,0.45) !important;
  outline: none;
}
/* Keep primary buttons readable with same neon ring */
.btn.primary:hover,
.btn.primary:focus,
.btn.primary:focus-visible {
  border-color: #d5aaff !important;
  box-shadow:
    0 0 0 2px rgba(198,138,255,0.40),
    0 0 22px rgba(198,138,255,0.55) !important;
}
/* Overlay buttons share the same interaction effect */
.overlay .panel .btn:hover,
.overlay .panel .btn:focus,
.overlay .panel .btn:focus-visible {
  border-color: #d5aaff !important;
  box-shadow:
    0 0 0 2px rgba(198,138,255,0.35),
    0 0 18px rgba(198,138,255,0.50) !important;
}
/* Explicitly ensure chips DO NOT inherit button neon */
.chip, .chip:hover, .chip:focus { box-shadow: none !important; }


/* Fund chips: add soft neon on hover/focus and stronger when active */
.chips .chip {
  transition: border-color .2s ease, box-shadow .2s ease, transform .06s ease;
}
.chips .chip:hover,
.chips .chip:focus {
  border-color: #d5aaff !important;
  box-shadow:
    0 0 0 2px rgba(198,138,255,0.30),
    0 0 18px rgba(198,138,255,0.38) !important;
}
.chips .chip.on {
  border-color: #e1c0ff !important;
  box-shadow:
    0 0 0 2px rgba(198,138,255,0.36),
    0 0 22px rgba(198,138,255,0.48) !important;
}

/* Inputs: restore/strengthen neon on focus (date + search) */
input[type="date"]:focus,
input[type="text"]:focus,
select:focus,
textarea:focus {
  border-color:#e6caff !important;
  box-shadow:
    0 0 0 2px rgba(198,138,255,0.42),
    0 0 26px rgba(198,138,255,0.58) !important;
  outline:none;
}


/* === v4.8 — Fix fund chip glow (only on hover/focus; subtle when active) === */
.chips .chip{
  box-shadow: none !important;            /* default: NO glow */
  border-color: #c68aff !important;       /* bright border */
  transition: border-color .2s ease, box-shadow .2s ease, transform .06s ease;
}
.chips .chip:hover,
.chips .chip:focus-visible{
  border-color: #e1c0ff !important;
  box-shadow:
    0 0 0 2px rgba(198,138,255,0.26),
    0 0 16px rgba(198,138,255,0.34) !important;
  outline: none;
}
/* Active chip: keep it clean (no outer glow), just a crisp ring */
.chips .chip.on{
  box-shadow:
    inset 0 0 0 1px rgba(255,255,255,0.06),
    0 0 0 1px rgba(198,138,255,0.30) !important;
  border-color: #e1c0ff !important;
}
/* Active + hover/focus: allow the full glow */
.chips .chip.on:hover,
.chips .chip.on:focus-visible{
  box-shadow:
    0 0 0 2px rgba(198,138,255,0.34),
    0 0 22px rgba(198,138,255,0.46) !important;
  outline: none;
}


/* === v4.9 — Row-level click to open overlay (cursor hint) === */
#table tbody tr { cursor: pointer; }
#table tbody tr .gf-open { cursor: pointer; } /* ticker chip keeps its behavior */


/* === v4.11 — Fix chip glow clipping + arrow colors === */

/* Make sure the scroll row that contains #fundsChips does not clip shadows */
.row:has(#fundsChips){
  overflow: visible !important;
  padding-top: 4px;
  padding-bottom: 4px;
}

/* Give the chips wrapper a bit of breathing room */
#fundsChips{
  overflow: visible !important;
  padding: 2px 0;
}

/* Arrow colors aligned with Buy/Sell */
.buy .arrow { color: #16E8A5 !important; }
.sell .arrow { color: #EC6C51 !important; }


/* === v4.12 — Ticker avatars (local + online fallback) === */
.avatar{
  width:28px;height:28px;min-width:28px;border-radius:50%;
  display:inline-flex;align-items:center;justify-content:center;
  overflow:hidden;background:rgba(124,58,237,.18);
  border:1px solid rgba(198,138,255,.45);
  box-shadow:0 0 0 2px rgba(124,58,237,.12),0 2px 8px rgba(0,0,0,.35);
  margin-right:8px;
}
.avatar img{width:100%;height:100%;object-fit:cover;display:block}
.avatar .mono{font-size:12px;font-weight:700;letter-spacing:.3px;color:#fff;opacity:.9;text-transform:uppercase}
.td-name{display:flex;align-items:center}
.td-name .ticker-wrap{display:inline-flex;align-items:center;gap:6px}


/* === v4.13 — Header alignment & unified buy/sell colors === */

/* 1) Header alignment: left for text columns, right only for numeric */
#table thead th { text-align: left !important; }
#table thead th.num, #table tbody td.num { text-align: right !important; }

/* Popup table too */
.overlay .panel table thead th { text-align: left !important; }
.overlay .panel table thead th.num,
.overlay .panel table tbody td.num { text-align: right !important; }

/* 2) Unify BUY/SELL color: same for text and arrow */
td.num.buy, td.num.sell { font-weight: 700; }
td.num.buy  { color: #16E8A5 !important; }  /* green (buy) */
td.num.sell { color: #EC6C51 !important; }  /* red (sell) */
td.num .arrow { color: currentColor !important; } /* arrow matches text color */


/* === v4.14 — Overlay polish (solid, compact, header info) === */

/* Solid panel (no transparency) + narrower width */
.overlay { background: rgba(0,0,0,.78) !important; }
.overlay .panel{
  background: #14111c !important;   /* solid dark violet-ish */
  max-width: 600px !important;      /* narrower */
  width: 100% !important;
}

/* Header: align items and allow our badge row */
.overlay .panel .hdr{
  gap: 10px !important;
  align-items: center !important;
}

/* Compact table spacing + slightly smaller font */
.overlay .panel table{ table-layout: fixed; width: 100%; font-size: 14px; }
.overlay .panel table th, .overlay .panel table td{ padding: 6px 8px !important; }

/* Name row visuals inside header */
#focusTitle .td-name{ display:flex; align-items:center; gap:8px; }
#focusTitle .avatar{ width:28px; height:28px; min-width:28px; }
#focusTitle .ticker-pill{ font-size:12px; padding:4px 8px; }
#focusTitle .company{ color: var(--ink); opacity:.9; }


/* === V6-from-backup — Popup header tweaks === */
/* Smaller Follow button */
.overlay .panel .hdr #followBtn{
  padding: 6px 10px !important;
  font-size: 13px !important;
  border-radius: 999px !important;
  line-height: 1.1 !important;
}
/* Close as circular X */
.overlay .panel .hdr #closeOverlay{
  width: 32px; height: 32px;
  padding: 0 !important;
  display:flex; align-items:center; justify-content:center;
  border-radius: 999px !important;
  font-size: 18px !important;
  font-weight: 700 !important;
}


/* === V8 — Follow → Bookmark icon toggle === */
#followBtn{
  width: 36px; height: 36px;
  padding: 0 !important;
  display: inline-flex; align-items: center; justify-content: center;
  border-radius: 999px;
  line-height: 1;
}
#followBtn svg{ width: 18px; height: 18px; display:block; }
#followBtn svg path{ stroke: currentColor; fill: none; stroke-width: 2; }
#followBtn.on{
  background: var(--accent) !important;
  border-color: var(--accent) !important;
  color: var(--accent-ink) !important;
}
/* subtle hover ring like chips/buttons */
#followBtn:hover{
  border-color: #d5aaff !important;
  box-shadow:
    0 0 0 2px rgba(198,138,255,0.35),
    0 0 18px rgba(198,138,255,0.45) !important;
}


/* === V9-fix — External link icon button (before Save) === */
#openGFBtn{
  width: 36px; height: 36px;
  padding: 0 !important;
  display: inline-flex; align-items:center; justify-content:center;
  border-radius: 999px;
  line-height:1;
  margin-right: 4px; /* before the save button */
}
#openGFBtn svg{ width:18px; height:18px; display:block; }
#openGFBtn svg path{ stroke: currentColor; fill: currentColor; }
#openGFBtn:hover{
  border-color: #d5aaff !important;
  box-shadow:
    0 0 0 2px rgba(198,138,255,0.35),
    0 0 18px rgba(198,138,255,0.45) !important;
}


/* === V15 layout styles === */
.stat-card{ border:1px solid rgba(255,255,255,.08); }
.stat-card .big-num{ font-size:38px; font-weight:800; letter-spacing:.2px; }
.stat-card .badge{ background:rgba(255,255,255,.06); padding:8px 10px; border-radius:10px; }
#layoutTwoCol .card.pad label{ display:block; margin-bottom:4px; font-weight:600; }
@media (max-width: 980px){ #layoutTwoCol{ grid-template-columns: 1fr; } }


/* === V16 fixes === */
.results-head{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
.results-actions{ display:flex; align-items:center; gap:8px; }

#toggleMineBtn{
  width: 36px; height: 36px;
  padding: 0 !important;
  display: inline-flex; align-items:center; justify-content:center;
  border-radius: 999px; line-height:1;
}
#toggleMineBtn svg{ width:18px; height:18px; display:block; }
#toggleMineBtn svg path{ stroke: currentColor; fill: none; stroke-width: 2; }
#toggleMineBtn.on{
  background: var(--accent) !important;
  border-color: var(--accent) !important;
  color: var(--accent-ink) !important;
}
#toggleMineBtn:hover{
  border-color: #d5aaff !important;
  box-shadow: 0 0 0 2px rgba(198,138,255,0.35), 0 0 18px rgba(198,138,255,0.45) !important;
}

/* wrap chips to multiple lines */
#fundsChips .chips, #slot-fundsChips .chips{ display:flex; flex-wrap:wrap; gap:8px; }


/* === V25: strict two-column layout === */
#twoCol {
  display: grid;
  grid-template-columns: 360px 1fr;
  gap: 16px;
  align-items: start;
  margin-top: 12px;
}
#leftCol > .card.pad { margin-bottom: 12px; }
#statsRow { display: grid; grid-template-columns: 1fr; gap: 12px; }
#statsRow .card.pad { box-shadow: inset 0 0 0 1px rgba(198,138,255,.35); border-radius: 16px; min-height: 96px; display: flex; }
#filterHeader{ min-height: 96px; padding: 6px 0; margin-bottom: 8px; display:flex; align-items:center; }
.stats-funds-grid{ display:none !important; } /* hide legacy summary */
#slot-fundsChips .chips, #fundsChips .chips { display:flex; flex-wrap:wrap; gap:8px; }

/* Results header actions (bookmark) */
/* Results icon white and slightly larger */
.muted svg {
  fill: #fff !important;
  width: 20px !important;
  height: 20px !important;
}
/* Icon color & alignment for Refresh / CSV buttons */
#fetchBtn svg,
#csvBtn svg {
  fill: #fff;
  vertical-align: middle;
  margin-top: -1px;
}

#csvBtn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}

#csvBtn strong {
  color: #fff;
}
/* Stat-cards as filter chips */
.stat-card{ cursor: pointer; transition: box-shadow .15s ease, border-color .15s ease, background .15s ease; }
.stat-card:hover{
  border-color: #d5aaff !important;
  box-shadow: 0 0 0 2px rgba(198,138,255,0.35), 0 0 18px rgba(198,138,255,0.45) !important;
}
.stat-card.active{
  background: rgba(198,138,255,0.12) !important;
  border-color: var(--accent) !important;
  box-shadow: 0 0 0 2px rgba(198,138,255,0.45), inset 0 0 0 1px rgba(198,138,255,0.35) !important;
}
/* Results header layout */
.results-head{ display:grid; grid-template-columns: 1fr auto 1fr; align-items:center; gap:12px; }
.results-left{ display:flex; align-items:center; gap:12px; }
.results-center{ display:flex; align-items:center; justify-content:center; gap:6px; } /* tighter gap */
.results-right{ display:flex; align-items:center; justify-content:flex-end; gap:8px; }

/* Compact pager buttons */
.pager-btn{ width:36px; height:36px; border-radius:999px; display:inline-flex; align-items:center; justify-content:center; }

/* Pill-styled selects (uniform with theme) */
.pill-select, select#typeFilter{
  appearance:none; -webkit-appearance:none; -moz-appearance:none;
  background: var(--accent); color: #fff;
  border: 1px solid var(--line);
  border-radius: 999px;
  padding: 6px 12px;
  font-weight: 700;
  cursor: pointer;
}
.pill-select:hover, select#typeFilter:hover{
  border-color: #d5aaff !important;
  box-shadow: 0 0 0 2px rgba(198,138,255,0.35), 0 0 18px rgba(198,138,255,0.45) !important; /* neon glow */
}
.pill-select:focus, select#typeFilter:focus{
  outline: none;
  box-shadow: 0 0 0 2px rgba(198,138,255,0.35), 0 0 18px rgba(198,138,255,0.45) !important;
}
.results-head{ display:grid; grid-template-columns: 1fr auto 1fr; align-items:center; gap:12px; }
.results-left{ display:flex; align-items:center; gap:12px; }
.inline-size{ display:flex; align-items:center; gap:8px; }
.results-center{ display:flex; align-items:center; justify-content:center; gap:10px; }
.results-right{ display:flex; align-items:center; justify-content:flex-end; gap:8px; }

/* Pager buttons compact */
.pager-btn{ width:36px; height:36px; border-radius:999px; display:inline-flex; align-items:center; justify-content:center; }

/* Pill-styled selects (page size + trade type) */
.pill-select, select#typeFilter{
  appearance:none; -webkit-appearance:none; -moz-appearance:none;
  background: var(--accent); color: #fff;
  border: 1px solid var(--line);
  border-radius: 999px;
  padding: 6px 10px;
}
.pill-select:focus, select#typeFilter:focus{ outline: none; box-shadow: 0 0 0 2px rgba(198,138,255,0.35); }
.results-head{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
.results-actions{ display:flex; align-items:center; gap:8px; }
#toggleMineBtn{
  width:36px; height:36px; padding:0 !important; display:inline-flex; align-items:center; justify-content:center;
  border-radius:999px; line-height:1;
}
#toggleMineBtn svg{ width:18px; height:18px; display:block; }
#toggleMineBtn svg path{ stroke: currentColor; fill: none; stroke-width: 2; }
#toggleMineBtn.on{ color:#fff !important; background: var(--accent) !important; border-color: var(--accent) !important; }

@media (max-width: 980px){
  #twoCol{ grid-template-columns: 1fr; }
}


/* === V26 fixes === */
/* Popup bookmark active: white icon/text */
.overlay .panel .hdr #followBtn.on{
  color:#fff !important;
  background: var(--accent) !important;
  border-color: var(--accent) !important;
}
.overlay .panel .hdr #followBtn svg path{ stroke: currentColor; fill: none; stroke-width: 2; }


/* Tighten Search Filters header vertical spacing */
#filterHeader{ padding-top:0px !important; padding-bottom:0px !important; margin-bottom:8px !important; align-items:center; }

/* Compatta l’header dei filtri */
#filterHeader h3{
  margin: 0 !important;        /* elimina i 1em dell'user agent */
  line-height: 1.1;
}

/* facoltativo: ancora più stretto sopra/sotto */
#filterHeader{
  padding-top: 0px !important;
  padding-bottom: 0px !important;
}

/* solo se vedi ancora aria: può venire dal padding della card */
#filterCard > .row:first-child{
  margin-bottom: 0px !important;  /* da 10px a 6px o 4px */
}



/* === V27 — Slim Search Filters: big chip header + flat fields === */
#filterCard{ padding:14px 14px 16px; }
#filterHeader{
  background: rgba(124, 58, 237, 0.1);
  box-shadow: inset 0 0 0 1px rgba(198,138,255,.35);
  border-radius: 999px;
  padding: 10px 14px !important;
  margin-bottom: 12px !important;
  align-items: center;
}
#filterHeader h3{ margin:0 !important; line-height:1.15; }

/* Remove nested card look for inner blocks */
#filterCard > .row,
#filterCard > .card.pad{
  background: transparent !important;
  box-shadow: none !important;
  border: 0 !important;
  padding: 0 !important;
  margin: 10px 0 0 0 !important;
  border-radius: 0 !important;
}

/* Inner "field cards" in the two-column row (Start/End) */
#filterCard > .row > .card.pad{
  background: transparent !important;
  box-shadow: none !important;
  border: 0 !important;
  padding: 0 !important;
  margin: 0 !important;
}

/* Space between label and input */
#filterCard label{ display:block; margin: 0 0 6px 0; font-weight:600; }

/* Keep inputs full width */
#filterCard .input, #filterCard input[type="date"]{ width:100%; }

/* Funds chips area: keep wrapping and reduce extra margin */
#slot-fundsChips .chips{ display:flex; flex-wrap:wrap; gap:8px; }


/* === V28 — Filters chip simplified, funds removed, stat icons larger === */

/* Filter card: compact padding */
#filterCard{ padding:12px 14px 14px !important; }
/* Header as a single "chip" */
#filterHeader{
  background: rgba(124,58,237,0.10);
  box-shadow: inset 0 0 0 1px rgba(198,138,255,.35);
  border-radius: 999px;
  padding: 8px 12px !important;
  margin: 4px 0 10px 0 !important;
  display:flex; align-items:center; gap:10px;
}
#filterHeader h3{ margin:0 !important; line-height:1.1; font-weight:700; }
#filterHeader .icon svg{ width:18px; height:18px; stroke:currentColor; fill:none; stroke-width:2; }

/* Flatten inner groups: remove nested "card" look entirely */
#filterCard > .row, #filterCard > .card.pad{ background:transparent !important; border:0 !important; box-shadow:none !important; padding:0 !important; margin:10px 0 0 0 !important; border-radius:0 !important; }
#filterCard > .row > .card.pad{ margin:0 !important; }
#filterCard label{ display:block; margin:0 0 6px 0; font-weight:600; }
#filterCard .input, #filterCard input[type="date"]{ width:100%; }

/* Hide the Funds chips area entirely (UI) */
#slot-fundsChips, #fundsChips{ display:none !important; }
#filterCard .funds-block, #filterCard label[for="funds"]{ display:none !important; }

/* Stat cards: larger icon button on the right */
.stat-card{ position:relative; }
.stat-card .badge{
  margin-left:auto;
  width:36px; height:36px; border-radius:10px;
  display:flex; align-items:center; justify-content:center;
  font-size:18px;
}


/* === V29: remove Search Filters title + reposition stat icons === */

/* Remove header block of filters */
#filterHeader { display:none !important; }

/* Stat icons pinned to right edge */
.stat-card {
  position: relative;
  display: flex;
  flex-direction: column;
  justify-content: center;
}
.stat-card .badge {
  position: absolute;
  right: 18px;
  top: 50%;
  transform: translateY(-50%);
  width: 40px;
  height: 40px;
  font-size: 20px;
  border-radius: 12px;
  background: rgba(124,58,237,0.15);
  color: #a882ff;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 0 6px rgba(167,139,250,0.5);
}


/* === V30: stat icons padding + color swap, re-add compact Search Filters title === */

/* Stat icons to the right with more padding and color swap */
.stat-card .badge {
  right: 28px; /* more spacing from border */
  background: #a882ff; /* violet background */
  color: #1b0f3f; /* dark violet icon */
  box-shadow: 0 0 6px rgba(167,139,250,0.5);
}

/* Compact Search Filters title above inputs */
#filterTitle {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
  color: #fff;
  font-weight: 700;
  font-size: 1.1rem;
}
#filterTitle svg {
  width: 18px;
  height: 18px;
  stroke: currentColor;
  fill: none;
  stroke-width: 2;
}


/* === V31: stat chips hover glow + white text + thick mono icons === */
.stat-card{
  color: #ffffff;
  transition: box-shadow .2s ease, transform .2s ease;
}
.stat-card:hover{
  box-shadow: 0 0 0 2px rgba(168,130,255,0.25), 0 0 24px rgba(168,130,255,0.35);
  transform: translateY(-1px);
}
.stat-card .badge{
  right: 28px;
  background: #a882ff;   /* neon violet bg */
  color: #1b0f3f;        /* dark violet icon */
  box-shadow: 0 0 6px rgba(167,139,250,0.5);
}
/* Keep titles/subtexts readable on dark */
.stat-card .muted{ color: rgba(255,255,255,0.7); }


/* === V32: force white filled icons in stat badges === */
.stat-card .badge{
  right: 28px;
  width: 42px; height: 42px;
  border-radius: 12px;
  background: #a882ff; /* neon violet */
  box-shadow: 0 0 6px rgba(167,139,250,0.5);
}
.stat-card .badge svg{ width:24px; height:24px; display:block; }
.stat-card .badge svg path,
.stat-card .badge svg rect,
.stat-card .badge svg polygon{
  fill: #fff !important;
  stroke: none !important;
}


/* === V34: white filled SVGs in stat badges === */
.stat-card .badge {
  position: absolute;
  right: 28px;
  top: 50%;
  transform: translateY(-50%);
  width: 42px;
  height: 42px;
  border-radius: 12px;
  background: #a882ff;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 0 6px rgba(167,139,250,0.5);
}
.stat-card .badge svg *{
  fill: #fff !important;
  stroke: none !important;
}


/* === V35: centered vertical arrows white-filled === */
.stat-card .badge svg * { fill: #fff !important; stroke: none !important; }


/* === icons pipeline: load external SVGs from /icons === */
.stat-card .badge{
  position: absolute;
  right: 28px; top: 50%; transform: translateY(-50%);
  width: 42px; height: 42px; border-radius: 12px;
  background: #a882ff; display:flex; align-items:center; justify-content:center;
  box-shadow: 0 0 6px rgba(167,139,250,0.5);
}
.stat-card .badge .stat-icon{ width:24px; height:24px; display:block; }


/* === v5: uniform search width (Search Ticker/Fund = 235px like dates) === */
#slot-search input[type="text"]{ /* reset by v4.21 */ }
#slot-search{
  display: inline-flex;
  justify-content: flex-start;
}


/* === v5.1: exact equal widths for filters (dates + search) === */
#filterCard input[type="date"]{
  width: 235px !important;
  max-width: 235px !important;
  box-sizing: border-box !important;
  padding: 12px 12px !important;
  border-width: 1px !important;
}
#filterCard #slot-search input[type="text"]{ /* reset by v4.21 */ }
/* Center the three inputs inside their slots so outer edges align */
#slot-fromDate, #slot-toDate, #slot-search{
  display: flex !important;
  justify-content: center !important;
}


/* === v5.2: left-align filter inputs (no centering) === */
#slot-fromDate, #slot-toDate, #slot-search{
  display: flex !important;
  justify-content: flex-start !important;  /* align to the left */
}
#slot-search input[type="text"]{
  margin: 0 !important;   /* remove auto-centering */
}


/* === v6: slimmer filter column (260px) === */
#layoutTwoCol {
  grid-template-columns: 260px 1fr !important;
}
#filterCard {
  max-width: 260px !important;
}


/* v6.4: violet neon button link for Source note */
.api-status-btn {
  display:inline-block;
  background:#7c3aed;
  color:#0d0716 !important;
  font-weight:600;
  border-radius:999px;
  padding:2px 10px;
  text-decoration:none;
  box-shadow:0 0 12px rgba(124,58,237,.6);
  transition:all .2s ease;
  border:1px solid rgba(167,139,250,.35);
}
.api-status-btn:hover {
  box-shadow:0 0 18px rgba(167,139,250,.9);
  transform:translateY(-1px);
}


/* v6.5: violet neon style + larger text for title and source */
.api-status-btn {
  background:#3f3160;
  color:#fff !important;
  font-weight:700;
  border-radius:999px;
  padding:2px 16px;
  text-decoration:none;
  box-shadow:0 0 8px rgba(223, 95, 255, 0.6);
  transition:all .2s ease;
  border:1px solid #a882ff;
  font-size:12px;
}
.api-status-btn:hover {
  box-shadow:0 0 5px violet;
  transform:translateY(-1px);
}

/* Larger Source note */
p.note {
  font-size:11px !important;
  font-weight:600;
}

/* Larger ARK Trades title */
h1, #mainTitle, #titleARK {
  font-size:34px !important;
  letter-spacing:0px;
}


/* === v4.15 — Popup scrollbar violet + sticky header === */
.overlay .panel {
  display: flex;
  flex-direction: column;
  max-height: 85vh; /* already set above, reaffirm for clarity */
  overflow: auto;
}

/* Sticky header (ticker/title + buttons remain visible while scrolling) */
.overlay .panel .hdr {
  position: sticky;
  top: 0;
  z-index: 5;
  background: #14111c; /* match panel solid */
}

/* WebKit scrollbars (Panel + inner body) */
.overlay .panel::-webkit-scrollbar,
.overlay .panel .body::-webkit-scrollbar {
  width: 10px;
}
.overlay .panel::-webkit-scrollbar-track,
.overlay .panel .body::-webkit-scrollbar-track {
  background: rgba(124,58,237,0.12);
  border-radius: 10px;
}
.overlay .panel::-webkit-scrollbar-thumb,
.overlay .panel .body::-webkit-scrollbar-thumb {
  background: linear-gradient(180deg, #a882ff, #7c3aed);
  border-radius: 10px;
}
.overlay .panel::-webkit-scrollbar-thumb:hover,
.overlay .panel .body::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(180deg, #d5b8ff, #9b5cf3);
}

/* Firefox scrollbar colors */
.overlay .panel,
.overlay .panel .body {
  scrollbar-color: #7c3aed rgba(124,58,237,0.12);
  scrollbar-width: thin;
}


/* === v4.16 — Compact ticker search width + inline controls === */
#slot-search{
  display:inline-flex !important;
  align-items:center !important;
  gap:8px !important;
  flex-wrap:nowrap !important;
}
#slot-search .btn{ padding:10px 12px; } /* tighter fit */
#slot-search #clearBtn{ line-height:1; }


/* === v4.18 — Search inline order + spacing === */
#slot-search{ display:inline-flex !important; align-items:center !important; gap:10px !important; }
#slot-search #searchBox{ min-width: 240px; }
#slot-search #fetchBtn, #slot-search #clearBtn{ flex: 0 0 auto; }


/* === v4.19 — Clear 'X' inside search input + Export align === */
.search-wrap{
  position: relative;
  display: inline-block;
}
.search-wrap #searchBox{
  padding-right: 36px !important; /* room for the X */
}
.clear-inside{
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  width: 26px; height: 26px;
  padding: 0 !important;
  border-radius: 999px;
  display: inline-flex; align-items: center; justify-content: center;
  opacity: .9;
}
.clear-inside:hover{ opacity: 1; }
#slot-csvBtn{
  display:flex !important; justify-content:flex-start !important; align-items:center !important; }
#slot-csvBtn .btn{ margin-left: 0 !important; }


/* === v4.19.1 — Fix clear button motion and glow === */
.clear-inside,
.clear-inside:hover,
.clear-inside:focus,
.clear-inside:focus-visible{
  box-shadow: none !important;
  border-color: transparent !important;
  outline: none !important;
}
.clear-inside:active{
  transform: translateY(-50%) !important; /* lock position */
}


/* === v4.19.2 — Circular clear button with neon (no movement) === */
.clear-inside{
  position:absolute; right:8px; top:50%;
  transform: translateY(-50%); /* lock vertical center */
  width: 26px; height: 26px;
  padding: 0 !important;
  border-radius: 999px;
  border: 1px solid rgba(198,138,255,0.55);
  background: rgba(124,58,237,0.10);
  box-shadow: 0 0 0 1px rgba(255,255,255,0.06) inset;
  display: inline-flex; align-items:center; justify-content:center;
  transition: box-shadow .15s ease, border-color .15s ease, opacity .15s ease;
}
.clear-inside svg{ width:14px; height:14px; display:block; }
.clear-inside:hover,
.clear-inside:focus,
.clear-inside:focus-visible{
  border-color:#d5aaff;
  box-shadow:
    0 0 0 2px rgba(198,138,255,0.32),
    0 0 16px rgba(198,138,255,0.40);
  outline:none;
  opacity:1;
}
/* Keep it fixed in place even on :active */
.clear-inside:active{ transform: translateY(-50%); }


/* Hide Export CSV button/slot */
#csvBtn{ display:none !important; }
#slot-csvBtn{ display:none !important; }


/* === v4.21 — Clean reset: make Search fill available width === */
#filterCard #slot-search{
  display: flex !important;
  align-items: center !important;
  gap: 10px !important;
  min-width: 0 !important;
}
#filterCard #slot-search .search-inline{ display:flex !important; gap:10px !important; align-items:center !important; flex:1 1 auto !important; min-width:0 !important; }
#filterCard #slot-search .search-wrap{ position:relative; flex:1 1 auto !important; min-width:0 !important; display:block !important; }
#filterCard #slot-search input[type="text"]{
  width: 100% !important;
  max-width: none !important;
  min-width: 0 !important;
  flex: 1 1 auto !important;
}
#filterCard #slot-search .btn{ flex: 0 0 auto !important; }


/* === v4.22 — Search layout: prevent overlap with Enter === */
#filterCard #slot-search{
  display: flex !important;
  align-items: center !important;
  gap: 10px !important;
}
#filterCard #slot-search .search-inline{
  display: flex !important;
  align-items: center !important;
  gap: 10px !important;
  flex: 1 1 auto !important;
  min-width: 0 !important;
}
#filterCard #slot-search .search-wrap{
  position: relative;
  flex: 1 1 auto !important;
  min-width: 0 !important;
}
#filterCard #slot-search #searchBox{
  width: 100% !important;
  max-width: 100% !important;
  min-width: 0 !important;
  flex: 1 1 auto !important;
  padding-right: 40px !important; /* room for inner X */
}
#filterCard #slot-search #fetchBtn{
  width: 40px !important;
  height: 40px !important;
  padding: 0 !important;
  border-radius: 999px !important;
  flex: 0 0 40px !important; /* fixed size to avoid overlap */
}


/* === v4.22.1 — Prevent search input from extending under Enter === */
#filterCard #slot-search{ display:flex !important; align-items:center !important; gap:10px !important; }
#filterCard #slot-search .search-inline{ display:flex !important; align-items:center !important; gap:10px !important; flex-wrap:nowrap !important; width:100% !important; min-width:0 !important; }
#filterCard #slot-search .search-wrap{ position:relative; flex:1 1 auto !important; min-width:0 !important; }
#filterCard #slot-search #fetchBtn{ width:40px !important; height:40px !important; flex:0 0 40px !important; padding:0 !important; border-radius:999px !important; }
#filterCard #slot-search #searchBox{
  flex: 0 1 auto !important;
  width: calc(100% - 50px) !important; /* 40px button + 10px gap */
  max-width: calc(100% - 50px) !important;
  min-width: 0 !important;
  padding-right: 40px !important;  /* room for inner X */
}

</style>
<link crossorigin="True" href="https://fonts.gstatic.com" rel="preconnect"/><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/></head>
<body>
<div class="container">
<div class="row" style="justify-content:space-between;gap:12px">
<div>
<h1>ARK Trades – Dashboard (Dark v4)</h1>
<p class="note">Source: Unofficial API <a href="https://status.arkfunds.io/status/arkfunds" target="_blank" rel="noopener" class="api-status-btn">arkfunds.io ↗</a></p>
</div>
  
</div>
<section class="controls grid fit-240" style="display:none!important">
<div class="card pad date-card">
<label>From</label>
<input id="fromDate" type="date"/>
</div>
<div class="card pad date-card">
<label>To</label>
<input id="toDate" type="date"/>
</div>
<div class="card pad search-card">
<label>Search (ticker or fund)</label><div class="search-inline"><div class="search-wrap"><input id="searchBox" placeholder="e.g. NVDA" type="text"/><button class="btn icon clear-inside" id="clearBtn" title="Clear Search" aria-label="Clear Search"><svg viewBox="0 0 24 24" width="14" height="14" aria-hidden="true"><path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></button></div><button class="btn primary" id="fetchBtn" title="Search / Enter" aria-label="Search / Enter"><svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true"><path d="M19 7v4a2 2 0 0 1-2 2H5l4 4m0-8-4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg></button><button class="btn" id="csvBtn" title="Export CSV" aria-label="Export CSV"><svg viewBox="0 0 24 24" aria-hidden="true" style="width:16px;height:16px;margin-right:6px"><path d="M6 2h9l5 5v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2zm8 1.5V8h4.5"/></svg><strong>Export CSV</strong></button><button class="btn" id="clearBtn" title="Clear Search" aria-label="Clear Search"><svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true"><path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></button></div><div class="card pad" id="suggestions" style="position:absolute;z-index:1000;display:none;max-height:240px;overflow:auto;font-size:13px;pointer-events:auto"></div>
</div>
</section>
<section class="stats-funds-grid" style="margin-top:12px;margin-bottom:12px">
<div class="card pad stat">
<div class="label">Transactions displayed</div>
<div class="value" id="countBox">0</div>
</div>
<div class="card pad stat">
<div class="label">Funds selected</div>
<div class="value" id="fundCount">0</div>
</div>
<div class="card pad">
<div class="row" style="gap:12px;align-items:center;justify-content:space-between;flex-wrap:nowrap">
<div class="row" style="gap:12px;flex:1 1 auto;overflow-x:auto;white-space:nowrap">
<span class="muted">Funds:</span>
<div class="chips" id="fundsChips"></div>
</div>
<label><input id="onlyMine" type="checkbox"/> Only my tickers</label>
</div>
</div>
</section>
<!-- Full-width results table -->

<!-- === V15: Stats + Two-Column Layout === -->
<section id="statsRow" class="grid" style="grid-template-columns: repeat(3, minmax(0,1fr)); gap:12px; margin-top:12px;">
  <div class="card pad stat-card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div>
        <div class="muted">Total Transactions</div>
        <div class="big-num" id="statTotalN">0</div>
        <div class="muted">All ARK operations</div>
      </div>
      <div class="badge mono"><img class="stat-icon" src="icons/total_bars.svg" alt="total"></div>
    </div>
  </div>
  <div class="card pad stat-card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div>
        <div class="muted">Buys</div>
        <div class="big-num" id="statBuyN" style="color:#16E8A5">0</div>
        <div class="muted"><span id="statBuyPct">0%</span> of total</div>
      </div>
      <div class="badge mono"><img class="stat-icon" src="icons/buy_stairs.svg" alt="buy"></div>
    </div>
  </div>
  <div class="card pad stat-card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div>
        <div class="muted">Sells</div>
        <div class="big-num" id="statSellN" style="color:#EC6C51">0</div>
        <div class="muted"><span id="statSellPct">0%</span> of total</div>
      </div>
      <div class="badge mono"><img class="stat-icon" src="icons/sell_stairs.svg" alt="sell"></div>
    </div>
  </div>
</section>

<section id="layoutTwoCol" class="grid" style="grid-template-columns: 320px 1fr; gap:16px; align-items:start; margin-top:12px;">
  <div id="filterCard" class="card pad">
  <div id="filterTitle">
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M3 5h18l-7 8v5l-4 2v-7L3 5z"/>
    </svg>
    <span>Search Filters</span>
  </div>

    <div id="filterHeader" class="row" style="align-items:center;gap:10px;margin-bottom:10px">
      <div class="icon" style="opacity:.85"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 5h18l-7 8v5l-4 2v-7L3 5z" stroke="currentColor" fill="none" stroke-width="2"/></svg></div>
      <h3 style="margin:0">Search Filters</h3>
    </div>
    <div class="row" style="gap:12px">
      <div class="card pad" style="flex:1">
        <label>Start Date</label>
        <div id="slot-fromDate"></div>
      </div>
      <div class="card pad" style="flex:1">
        <label>End Date</label>
        <div id="slot-toDate"></div>
      </div>
    </div>
    <div class="card pad" style="margin-top:12px">
      <label>Search Ticker / Fund</label>
      <div id="slot-search"></div>
    </div>
    <div class="card pad" style="margin-top:12px">
      <label>ARK Funds</label>
      <div id="slot-fundsChips"></div>
      
    </div>
    <div class="card pad" style="display:none" style="margin-top:12px">
      <label>Trade Type</label>
      <select id="typeFilterLeft" class="pill-select">
        <option value="ALL" selected>All (Buy + Sell)</option>
        <option value="BUY">Buys only</option>
        <option value="SELL">Sells only</option>
      </select>
    </div>
    <div class="row" style="gap:10px;margin-top:12px">
      <div id="slot-fetchBtn"></div>
      <div id="slot-csvBtn"></div>
    </div>
  </div>

  <div id="resultsSlot"></div>
</section>

<section class="card pad">
<div class="results-head">
  <div class="results-left">
    <div class="muted" style="display:inline-flex;align-items:center"><svg viewBox="0 0 24 24" aria-hidden="true" style="width:16px;height:16px;margin-right:6px;opacity:.85"><path d="M3 5h18v2H3zm0 6h18v2H3zm0 6h12v2H3z"/></svg><span>Results</span></div>
  </div>

  <div class="results-center">
    <!-- Trade select removed per UX: controlled by stat-cards -->
    <select id="typeFilter" class="pill-select" style="display:none">
      <option value="ALL" selected>All (Buy + Sell)</option>
      <option value="BUY">Buys only</option>
      <option value="SELL">Sells only</option>
    </select>

    <button class="btn pager-btn" id="prevPage" title="Previous page">‹</button>
    <span id="pageInfo" class="muted" style="min-width:110px;text-align:center">Page 1 / 1</span>
    <button class="btn pager-btn" id="nextPage" title="Next page">›</button>
  </div>

  <div class="results-right">
    <button class="btn" id="toggleMineBtn" title="Only my tickers" aria-label="Only my tickers">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M6 4h12a1 1 0 0 1 1 1v15l-7-4-7 4V5a1 1 0 0 1 1-1z"/></svg>
    </button>
  </div>
</div><div class="muted" id="status" style="display:none">Ready.</div>
<div style="margin-top:12px;overflow:auto;">
<table id="table">
<colgroup>
<col style="width:48px"/>
<col style="width:39px"/>
<col style="width:300px"/>
<col style="width:112px"/>
</colgroup>
<thead>
<tr>
<th>Date</th>
<th>Fund</th>
<th>Ticker / Name</th>
<th class="num">Shares | %</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
  <div class="results-foot inside">
    <div class="results-center">
      <button class="btn pager-btn" id="prevPageBottom" title="Previous page">‹</button>
      <span id="pageInfoBottom" class="muted" style="min-width:110px;text-align:center">Page 1 / 1</span>
      <button class="btn pager-btn" id="nextPageBottom" title="Next page">›</button>
    </div>
  </div>
</div>
</section>
</div>
<div class="overlay" id="overlay">
<div class="panel">
<div class="hdr">
<div id="focusTitle" style="font-weight:700">Ticker</div>
<button class="btn" id="openGFBtn" title="Open on Google Finance" aria-label="Open on Google Finance"><svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="10" stroke="currentColor" fill="none" stroke-width="2"/><path d="M8 16L16 8M9 8h7v7" stroke="currentColor" stroke-width="2" fill="none"/></svg></button><button class="btn" id="followBtn" title="Follow / Unfollow"><strong>Follow</strong></button>
<button class="btn close" id="closeOverlay"><strong>×</strong></button>
</div>
<div class="body">
<div class="muted" id="focusInfo" style="margin-bottom:8px"></div>
<div style="overflow:auto">
<table>
<colgroup>
<col style="width:100px"/>
<col style="width:80px"/>
<col style="width:130px"/>
</colgroup>
<thead><tr>
<th style="width:120px">Date</th>
<th style="width:90px">Fund</th>
<th class="num" style="width:140px">Shares | %</th>
</tr></thead>
<tbody id="focusBody"></tbody>
</table>
</div>
</div>
</div>
</div>
<script>
(function(){
  const FUNDS = ["ARKK","ARKG","ARKQ","ARKF","ARKX","ARKW"];
  function getMyTickers(){try{return JSON.parse(localStorage.getItem("MY_TICKERS")||"[]");}catch(e){return []}}
function setMyTickers(arr){localStorage.setItem("MY_TICKERS",JSON.stringify(arr))}


const NAME_MAP = {
  "TXG":"10x Genomics, Inc.",
  "HO":"Thales",
  "2618":"JD Logistics Inc.",
  "4689":"LY Corp. (Yahoo Japan Corp.)",
  "6301":"Komatsu Ltd.",
  "AACT":"Ares Acquisition Corporation II",
  "ABNB":"Airbnb, Inc.",
  "ABSI":"Absci Corporation",
  "ACHR":"Archer Aviation Inc.",
  "ADPT":"Adaptive Biotechnologies Corp.",
  "AMD":"Advanced Micro Devices",
  "AMGN":"Amgen Inc.",
  "AMZN":"Amazon.com, Inc.",
  "ANSS":"Ansys Inc.",
  "ARCT":"Arcturus Therapeutics Holdings, Inc.",
  "ARKB":"ARK 21Shares Bitcoin ETF",
  "ATAI":"Atai Life Sciences, Inc.",
  "AUR":"Aurora Innovation, Inc.",
  "AVAV":"AeroVironment, Inc.",
  "AVDX":"AvidXchange Holdings Inc.",
  "BABA":"Alibaba Group Holding",
  "BBAI":"BigBear.ai Holdings, Inc.",
  "BEAM":"Beam Therapeutics, Inc.",
  "BIDU":"Baidu Inc.",
  "BLDE":"Blade Air Mobility, Inc.",
  "BLSH":"Bullish Holdings, Inc.",
  "BMNR":"Bitmine Immersion Technologies",
  "BREA":"Brea Holdings PLC",
  "BWXT":"BWX Technologies Inc.",
  "BYDDY":"BYD Company Limited",
  "CAI":"Cairn Energy plc",
  "CAT":"Caterpillar Inc.",
  "CCJ":"Cameco Corporation",
  "CDNA":"CareDx, Inc.",
  "CMPS":"COMPASS Pathways plc",
  "COIN":"Coinbase Global, Inc.",
  "CRCL":"Circle Energy Inc.",
  "CRISPR":"CRISPR Therapeutics",
  "CRSP":"CRISPR Therapeutics",
  "CRWD":"CrowdStrike Holdings, Inc.",
  "CRWV":"Crown Electrokinetics Corp.",
  "DDD":"3D Systems Corporation",
  "DASH":"DoorDash, Inc.",
  "DDOG":"Datadog, Inc.",
  "DE":"Deere & Company",
  "DKNG":"DraftKings Inc.",
  "DSY":"Dassault Systèmes SE",
  "ENI":"Eni SpA",
  "ESLT":"Elbit Systems Ltd.",
  "ETOR":"eToro Group Ltd.",
  "ETHQ.U":"Etho Capital Quantum ETF (Unit)",
  "EXAS":"Exact Sciences Corporation",
  "FIG":"Figma Inc.",
  "FUTU":"Futu Holdings Limited",
  "GENI":"Genius Sports Limited",
  "GH":"Guardant Health, Inc.",
  "GOOG":"Alphabet Inc. (Class C)",
  "GOOGL":"Alphabet Inc. (Class A)",
  "GTLB":"GitLab Inc.",
  "HIVE":"Hive Digital Technologies",
  "HON":"Honeywell International Inc.",
  "HOOD":"Robinhood Markets, Inc.",
  "IBTA":"Ibotta, Inc.",
  "ILMN":"Illumina, Inc.",
  "INTC":"Intel Corporation",
  "INTU":"Intuit Inc.",
  "IONIS":"Ionis Pharmaceuticals, Inc.",
  "IONS":"Ionis Pharmaceuticals Inc.",
  "IRDM":"Iridium Communications Inc.",
  "ISRG":"Intuitive Surgical Inc.",
  "ISP":"Intesa Sanpaolo",
  "JOBY":"Joby Aviation, Inc.",
  "KDK":"Kodiak AI, Inc.",
  "KIND":"Nextdoor Holdings Inc.",
  "KLAR":"Klarna",
  "KMTUY":"Komatsu Ltd. (ADR)",
  "KSPI":"Kaspien Holdings Inc.",
  "KTOS":"Kratos Defense & Security",
  "LHX":"L3Harris Technologies",
  "LMT":"Lockheed Martin Corporation",
  "LUNR":"Intuitive Machines, Inc.",
  "MASS":"908 Devices, Inc.",
  "MELI":"MercadoLibre Inc.",
  "META":"Meta Platforms",
  "MGA":"Magna International Inc.",
  "MSFT":"Microsoft Corporation",
  "NFLX":"Netflix, Inc.",
  "NET":"Cloudflare, Inc.",
  "NRIX":"Nurix Therapeutics, Inc.",
  "NTLA":"Intellia Therapeutics",
  "NTRA":"Natera, Inc.",
  "NU":"Nu Holdings Ltd.",
  "NVDA":"NVIDIA Corporation",
  "OKLO":"Oklo Inc.",
  "ORCL":"Oracle Corporation",
  "PACB":"Pacific Biosciences of California, Inc.",
  "PATH":"UiPath Inc.",
  "PD":"PagerDuty, Inc.",
  "PINS":"Pinterest, Inc.",
  "PLTR":"Palantir Technologies Inc.",
  "PLUG":"Plug Power Inc.",
  "PONY":"Pony.ai, Inc.",
  "PRME":"Prime Medicine, Inc.",
  "PRNT":"ARK 3D Printing ETF (PRNT)",
  "PSNL":"Personalis, Inc.",
  "PSTG":"Pure Storage Inc.",
  "PYPL":"PayPal Holdings, Inc.",
  "QCOM":"Qualcomm Incorporated",
  "QSI":"Quantum-Si Incorporated",
  "RBLX":"Roblox Corporation",
  "RBRK":"Rubrik, Inc.",
  "RDDT":"Reddit, Inc.",
  "REKR":"Rekor Systems Inc.",
  "RKLB":"Rocket Lab USA, Inc.",
  "ROKU":"Roku Inc.",
  "RPTX":"Repare Therapeutics Inc.",
  "RXRX":"Recursion Pharmaceuticals, Inc.",
  "SDGR":"Schrödinger, Inc.",
  "SHOP":"Shopify Inc.",
  "SLMT":"Brea Holdings PLC",
  "SOFI":"SoFi Technologies, Inc.",
  "SOLQ.U":"Solidion Technology Inc. (Unit)",
  "SNPS":"Synopsys Inc.",
  "SPOT":"Spotify Technology S.A.",
  "SYM":"Symbotic Inc.",
  "TDY":"Teledyne Technologies Inc.",
  "TEM":"Tempus AI Inc.",
  "TER":"Teradyne, Inc.",
  "TOST":"Toast, Inc.",
  "TRMB":"Trimble Inc.",
  "TSLA":"Tesla Inc.",
  "TSM":"Taiwan Semiconductor Manufacturing Co. Ltd.",
  "TTD":"The Trade Desk, Inc.",
  "TWST":"Twist Bioscience Corporation",
  "U":"Unity Software Inc.",
  "UNH":"UnitedHealth Group",
  "VCYT":"Veracyte Inc.",
  "VEEV":"Veeva Systems Inc.",
  "VRTX":"Vertex Pharmaceuticals Inc.",
  "WGS":"GeneDx Holdings Corp",
  "XYZ":"XYZ Reality Ltd.",
  "Z":"Zillow Group, Inc."
};

  // Theme
  /* Tema fisso dark: rimosso toggle */

  // DOM refs
  const fromDate = document.getElementById('fromDate');
  const toDate = document.getElementById('toDate');
  const searchBox = document.getElementById('searchBox');
  const fetchBtn = document.getElementById('fetchBtn');
  const csvBtn = document.getElementById('csvBtn');
  const fundsChips = document.getElementById('fundsChips');
  const onlyMine = document.getElementById('onlyMine');
  const status = document.getElementById('status');
  const tbody = document.getElementById('tbody');
  const countBox = document.getElementById('countBox');
  const fundCount = document.getElementById('fundCount');
  const overlay = document.getElementById('overlay');
  const closeOverlay = document.getElementById('closeOverlay');
  const followBtn = document.getElementById('followBtn');
  let focusTicker = '';
try{ refreshFollowBtn(); }catch(e){}
 // --- Google Finance: exchange mapping (corretto al 23 Oct 2025) ---
const EXCHANGE_MAP = {
  // NASDAQ
  "ABNB":"NASDAQ","ABSI":"NASDAQ","ACHR":"NASDAQ","ADPT":"NASDAQ","AMGN":"NASDAQ",
  "AMD":"NASDAQ","AMZN":"NASDAQ","CMPS":"NASDAQ","CDNA":"NASDAQ","COIN":"NASDAQ",
  "CRSP":"NASDAQ","DDOG":"NASDAQ","EXAS":"NASDAQ","GOOG":"NASDAQ","GOOGL":"NASDAQ",
  "HIVE":"NASDAQ","ILMN":"NASDAQ","INTC":"NASDAQ","IONS":"NASDAQ","IRDM":"NASDAQ",
  "ISRG":"NASDAQ","MASS":"NASDAQ","META":"NASDAQ","MSFT":"NASDAQ","NFLX":"NASDAQ",
  "NVDA":"NASDAQ","PACB":"NASDAQ","PLTR":"NASDAQ",   // dal 26 Nov 2024 è su Nasdaq
  "PLUG":"NASDAQ","QCOM":"NASDAQ","QSI":"NASDAQ","RKLB":"NASDAQ","REKR":"NASDAQ",
  "SNPS":"NASDAQ","SYM":"NASDAQ","TRMB":"NASDAQ","TSLA":"NASDAQ","TTD":"NASDAQ",
  "TXG":"NASDAQ","U":"NYSE",   // Unity è NYSE (vedi sotto, lasciato qui come memo)
  "VCYT":"NASDAQ","VRTX":"NASDAQ",

  // NYSE
  "ARCT":"NASDAQ","AVAV":"NYSE","AVDX":"NASDAQ", // AvidXchange è NASDAQ
  "BABA":"NYSE","BLDE":"NYSE","BWXT":"NYSE","CCJ":"NYSE","DE":"NYSE",
  "DASH":"NASDAQ","ENI":"NYSE","GENI":"NYSE","HON":"NASDAQ","JOBY":"NYSE",
  "KIND":"NYSE","LHX":"NYSE","MELI":"NASDAQ", // MELI è NASDAQ (memo)
  "OKLO":"NYSE","ORCL":"NYSE","PATH":"NYSE","PD":"NYSE","PINS":"NYSE",
  "PSTG":"NYSE","RBLX":"NYSE","RBRK":"NYSE","ROKU":"NASDAQ",
  "SHOP":"NASDAQ",   // trasferita da NYSE a NASDAQ (Mar 2025)
  "TDY":"NYSE","UNH":"NYSE","VEEV":"NYSE",

  // ETF / altri USA
  "ARKB":"BATS",     // Cboe BZX (Google Finance usa “BATS”)
  "ARKB.US":"BATS",

 // --- ADR / OTC US (Google Finance usa "OTCMKTS")
"BYDDY":"OTCMKTS",
"KMTUY":"OTCMKTS",
"BMNR":"OTCMKTS",

// --- Estero (codici Google Finance)
"2618":"HKG",   // JD Logistics (Hong Kong)
"6301":"TYO",   // Komatsu (Tokyo)
"4689":"TYO",   // LY / Yahoo Japan (Tokyo)
"HO":"EPA",     // Thales (Euronext Paris)

// --- Italia (se vuoi la nativa di Borsa Italiana per ISP)
"ISP":"BIT",

  // NB: per ticker non mappati resta il fallback alla ricerca GF
};

  function googleFinanceURL(ticker){
    if(!ticker) return 'https://www.google.com/finance';
    const sym = String(ticker).trim().toUpperCase();
    const ex  = EXCHANGE_MAP[sym];
    if (ex){ return `https://www.google.com/finance/quote/${encodeURIComponent(sym)}:${encodeURIComponent(ex)}`; }
    // Default to NASDAQ if unknown
    return `https://www.google.com/finance?q=${encodeURIComponent(sym)}`;
  }
  const goGFBtn = document.getElementById('goGFBtn');
  if (goGFBtn){
    goGFBtn.onclick = (e)=>{
      if(!focusTicker) return;
      const sym = String(focusTicker).trim().toUpperCase();
      const mapEx = EXCHANGE_MAP[sym];
      const urlPrimary = mapEx ? `https://www.google.com/finance/quote/${encodeURIComponent(sym)}:${encodeURIComponent(mapEx)}`
                               : null;
      const urlAlt = (mapEx === 'NASDAQ') ? `https://www.google.com/finance/quote/${encodeURIComponent(sym)}:NYSE`
                    : (mapEx === 'NYSE') ? `https://www.google.com/finance/quote/${encodeURIComponent(sym)}:NASDAQ`
                    : `https://www.google.com/finance/quote/${encodeURIComponent(sym)}:NASDAQ`;
      const urlSearch = `https://www.google.com/finance?q=${encodeURIComponent(sym)}`;
      
      // Shift-click: apri entrambe (power user); Alt-click: forza exchange opposto
      if (e && e.shiftKey){
        if (urlPrimary) window.open(urlPrimary, '_blank', 'noopener');
        window.open(urlAlt, '_blank', 'noopener');
        return;
      }
      if (e && e.altKey){
        window.open(urlAlt, '_blank', 'noopener');
        return;
      }
      // Normale: se abbiamo exchange mappato, usa quello; altrimenti vai su ricerca
      if (urlPrimary){
        window.open(urlPrimary, '_blank', 'noopener');
      } else {
        window.open(urlSearch, '_blank', 'noopener');
      }
    };
  }

  const focusTitle = document.getElementById('focusTitle');
  const focusInfo  = document.getElementById('focusInfo');
  const focusBody  = document.getElementById('focusBody');
  closeOverlay.onclick = ()=> overlay.style.display='none';
  
  followBtn.onclick = ()=>{
    if(!focusTicker) return;
    let mine = getMyTickers();
    if(mine.includes(focusTicker)){
      mine = mine.filter(t=>t!==focusTicker);
    } else {
      mine.push(focusTicker);
    }
    setMyTickers(mine);
    refreshFollowBtn();
    render();
  };
  searchBox.addEventListener('keydown', (e)=>{
    if(e.key==='Escape'){ searchBox.value=''; hideSuggestions(); render(); return; }
    if(e.key==='Enter'){
      const qraw = (searchBox.value||'');
      const q = qraw.toLowerCase().trim();
      if(!q){ hideSuggestions(); render(); return; }
      const exactTicker = Object.keys(NAME_MAP).find(t => t.toLowerCase() === q);
      const exactName = Object.entries(NAME_MAP).find(([t,n]) => (n||'').toLowerCase() === q);
      if (exactTicker){ applySuggestion(exactTicker); e.preventDefault(); return; }
      if (exactName){ applySuggestion(exactName[0]); e.preventDefault(); return; }
      const suggestions = Object.entries(NAME_MAP)
        .filter(([t,n]) => t.toLowerCase().startsWith(q) || ((n||'').toLowerCase().startsWith(q)))
        .slice(0,10);
      if (suggestions.length){ applySuggestion(suggestions[0][0]); e.preventDefault(); return; }
      hideSuggestions(); render();
    }
  });


  // Default range: ultimi 7 giorni fino ad oggi
  (function setDefaultDates(){
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth()+1).padStart(2,'0');
  const dd = String(today.getDate()).padStart(2,'0');
  toDate.value = `${yyyy}-${mm}-${dd}`;

  const d2 = new Date(today);
  d2.setDate(d2.getDate() - 7);

  const yyyy2 = d2.getFullYear();
  const mm2 = String(d2.getMonth()+1).padStart(2,'0');
  const dd2 = String(d2.getDate()).padStart(2,'0');
  fromDate.value = `${yyyy2}-${mm2}-${dd2}`;

// === Export CSV Fix ===
function escapeCSV(v){
  if (v == null) return '';
  const s = String(v).replace(/"/g, '""');
  return /[",\n;]/.test(s) ? `"${s}"` : s;
}
function downloadCSV(){
  const rows = getFiltered ? getFiltered() : [];
  const header = ['Date','Fund','Ticker','Name','Direction','Shares','Weight %'];
  const lines = [header.join(',')];
  rows.forEach(r => {
    const name = NAME_MAP[r.ticker] || '';
    const direction = String(r.direction||'').toUpperCase();
    const shares = (r.shares==null ? '' : String(r.shares));
    const weight = (r.etf_percent==null ? '' : String(r.etf_percent));
    lines.push([r.date, r.fund, r.ticker, name, direction, shares, weight].map(escapeCSV).join(','));
  });
  const csv = '\ufeff' + lines.join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'ark_trades.csv';
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
}
if (typeof csvBtn !== 'undefined' && csvBtn) csvBtn.onclick = downloadCSV;


  // Clear search button logic
  (function(){
    const clr = document.getElementById("clearBtn");
    if (clr) {
      clr.addEventListener("click", () => {
        const s = document.getElementById("searchBox");
        if (s) {
          s.value = "";
          s.focus();
        }
        // optionally hide suggestions if visible
        const sug = document.getElementById("suggestions");
        if (sug) sug.style.display = "none";
      });
    }
  })();

})();

  // Chips fondi (sempre visibili, indipendenti dal fetch)
  const selected = new Set(FUNDS);
  function renderChips(){
    fundsChips.innerHTML = "";
    FUNDS.forEach(f => {
      const chip = document.createElement('button');
      chip.className = 'chip ' + (selected.has(f) ? 'on' : '');
      chip.textContent = f;
      chip.onclick = () => { selected.has(f) ? selected.delete(f) : selected.add(f); renderChips(); updateFundCount(); fetchAll(); };
      fundsChips.appendChild(chip);
    });
  }
  function updateFundCount(){ fundCount.textContent = selected.size; }
  renderChips(); updateFundCount();

  function fmtNum(n){ if(n==null || isNaN(n)) return ""; return Number(n).toLocaleString('it-IT'); }
function fmtPct(n){ if(n==null || n===undefined || isNaN(n)) return ""; return Number(n).toFixed(4).replace(/\.0+$/,''); }
function fmtSignShares(dir, n){ if(n==null || isNaN(n)) return ""; var s = fmtNum(Math.abs(Number(n))); return (String(dir).toUpperCase()==='BUY' ? '+' : '-') + s; }
function fmtDateDMY(ymd){ // expects 'YYYY-MM-DD' -> 'DD/MM/YY'
  if(!ymd) return '';
  var p = String(ymd).split('-'); if(p.length!==3) return ymd;
  var yy = p[0].slice(2); return p[2] + '/' + p[1] + '/' + yy;
}

  function coerceArray(json){
    if (Array.isArray(json)) return json;
    if (!json || typeof json !== 'object') return [];
    if (Array.isArray(json.data)) return json.data;
    if (Array.isArray(json.results)) return json.results;
    if (Array.isArray(json.items)) return json.items;
    if (Array.isArray(json.trades)) return json.trades;
    return [];
  }

  async function fetchFund(fund, from, to){
    const url = new URL('https://arkfunds.io/api/v2/etf/trades');
    url.searchParams.set('symbol', fund);
    url.searchParams.set('date_from', from);
    url.searchParams.set('date_to', to);
    url.searchParams.set('limit', '2000');
    const res = await fetch(url);
    if(!res.ok){ throw new Error(`Data not available (${res.status}) per ${fund}`); }
    const arr = coerceArray(await res.json());
    return arr.map(x => ({...x, fund}));
  }function hashHue(str){ let h=0; for (let i=0;i<str.length;i++){ h=(h*31 + str.charCodeAt(i))%360; } return h; }
  function tickerStyles(t){ const h=hashHue(t||''); return {bg:`hsl(${h},60%,20%)`, fg:`hsl(${h},85%,85%)`}; }


  
  // === Weight enrichment via /v2/stock/trades ===
  const weightMap = new Map(); // key: date|fund|ticker -> etf_percent

  function wkey(r){ return [r.date||'', r.fund||'', r.ticker||''].join('|'); }

  async function fetchWeightsForTicker(ticker, from, to){
    if(!ticker) return;
    try{
      const url = new URL('https://arkfunds.io/api/v2/stock/trades');
      url.searchParams.set('symbol', ticker);
      if(from) url.searchParams.set('date_from', from);
      if(to) url.searchParams.set('date_to', to);
      url.searchParams.set('limit', '2000');
      const res = await fetch(url);
      if(!res.ok) return;
      const data = await res.json();
      const trades = (data && (data.trades || data.data || data.results || data.items)) || [];
      for(const t of trades){
        const key = [t.date||'', t.fund||'', (t.symbol||t.ticker||ticker)].join('|');
        if(t.etf_percent!=null) weightMap.set(key, Number(t.etf_percent));
      }
    }catch(e){ /* silent */ }
  }

  function mergeWeights(rows){
    for(const r of rows){
      const pct = weightMap.get(wkey(r));
      if(pct!=null){ r.etf_percent = pct; }
    }
  }


  // --- Yahoo Finance price fetch helpers ---
  function chunk(arr, size){ const out=[]; for(let i=0;i<arr.length;i+=size){ out.push(arr.slice(i,i+size)); } return out; }

  async function fetchPricesYahoo(tickers){
    const priceMap = {};
    const batches = chunk(tickers, 50); // avoid URL too long
    for (const part of batches){
      const url = 'https://query1.finance.yahoo.com/v7/finance/quote?symbols=' + encodeURIComponent(part.join(','));
      try{
        const res = await fetch(url, {mode:'cors'});
        if(!res.ok) continue;
        const data = await res.json();
        const list = (data && data.quoteResponse && Array.isArray(data.quoteResponse.result)) ? data.quoteResponse.result : [];
        for (const q of list){
          const sym = q.symbol;
          const px  = Number(q.regularMarketPrice || q.postMarketPrice || q.bid || 0) || 0;
          if (sym && px>0) priceMap[sym] = px;
        }
      }catch(e){
        // ignore this batch
      }
    }
    return priceMap;
  }

  let allRows=[];

  
  async function fetchAll(){
    try{
      status.textContent = 'Loading…'; tbody.innerHTML=''; allRows=[];
      const from = fromDate.value, to = toDate.value, funds = Array.from(selected);
      const errors=[];
      for (const f of funds){
        try{ const part = await fetchFund(f, from, to); allRows.push(...part); }
        catch(e){ errors.push(e.message||String(e)); }
      }
      // If search is an exact TICKER, enrich with weights
      const qraw = (searchBox.value||'').trim();
      const q = qraw.toUpperCase();
      const exactTicker = q && /^[A-Z0-9\.\-]+$/.test(q) ? q : null;
      if (exactTicker){
        await fetchWeightsForTicker(exactTicker, from, to);
        mergeWeights(allRows);
      }
      render();
      status.textContent = errors.length ? ('Partial: ' + errors.join(' | ')) : `Loaded ${allRows.length} operations.`;
    }catch(e){ console.error(e); status.textContent='Error: '+(e.message||e); }
  }


  function getFiltered(){
    const q=(searchBox.value||'').trim().toLowerCase(); const mine=onlyMine.checked;
    return allRows.filter(r=>{
      if (mine && !getMyTickers().includes(r.ticker)) return false;
      if (q && !(String(r.ticker).toLowerCase().includes(q) || String(r.fund).toLowerCase().includes(q))) return false;
      return true;
    }).sort((a,b)=> (a.date<b.date?1:-1));
  }

  function render(){
    const filtered = getFiltered();
    tbody.innerHTML='';
    if (!filtered.length){
      const tr=document.createElement('tr'); const td=document.createElement('td'); td.colSpan=4; td.className='muted'; td.textContent='No results for current filters.'; tr.appendChild(td); tbody.appendChild(tr);
    } else {
      for (const r of filtered){
        const dir=String(r.direction||'').toUpperCase();
        const name=NAME_MAP[r.ticker]||'';
        const s=tickerStyles(r.ticker||'');
        const tr=document.createElement('tr');
        tr.setAttribute("data-ticker", r.ticker||"");
        tr.innerHTML = `
<td>${fmtDateDMY(r.date||'')}</td>
<td>${r.fund||''}</td>
<td>
  <span class="ticker-pill gf-open" data-ticker="${r.ticker||''}" style="background:${s.bg};color:${s.fg}">${r.ticker||''}</span>
  ${name?`<a class="name-open muted" data-ticker="${r.ticker||''}" style="font-size:12px;margin-left:6px;cursor:pointer">${name}</a>`:''}
</td>
<td class="num ${dir==='BUY'?'buy':'sell'}">${fmtNum(r.shares)} | ${fmtPct(r.etf_percent)} <span class="arrow">${dir==='BUY'?'▲':'▼'}</span></td>
`;
        tbody.appendChild(tr);
      }
    }
    countBox.textContent = filtered.length.toLocaleString('it-IT');
    // Attach fresh listeners after render

// Row-level open: click anywhere on the row opens the overlay, except on the ticker chip (gf-open)
tbody.addEventListener('click', (e)=>{
  if (e.target.closest('.gf-open')) return; // let the ticker chip open Google Finance
  const tr = e.target.closest('tr');
  const t = tr && tr.getAttribute('data-ticker');
  if (!t) return;
  openFocus(t);
}, false);

document.querySelectorAll('.name-open').forEach(el=>{
  el.addEventListener('click', (e)=>{
    e.preventDefault(); e.stopPropagation();
    openFocus(el.getAttribute('data-ticker')||'');
  });
});
document.querySelectorAll('.gf-open').forEach(el=>{
  el.addEventListener('click', (e)=>{
    e.preventDefault(); e.stopPropagation();
    const t = el.getAttribute('data-ticker')||'';
    const url = googleFinanceURL ? googleFinanceURL(t) : `https://www.google.com/finance/quote/${t}:NASDAQ`;
    window.open(url, '_blank', 'noopener');
  });
});
  }

  
  function isFollowed(t){ return getMyTickers().includes(t); }
  function refreshFollowBtn(){
  if(!focusTicker) return;
  const on = isFollowed(focusTicker);
  // Minimal bookmark icon (outline). When active, button bg turns violet.
  followBtn.innerHTML = '<svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">'
    + '<path d="M6 4h12a1 1 0 0 1 1 1v15l-7-4-7 4V5a1 1 0 0 1 1-1z" />'
    + '</svg>';
  followBtn.setAttribute('aria-pressed', on ? 'true' : 'false');
  followBtn.title = on ? 'Saved' : 'Save';
  followBtn.classList.toggle('on', on);
}

  async function openFocus(ticker){
    // ensure weights for this ticker
    await fetchWeightsForTicker(ticker, fromDate.value, toDate.value);
    mergeWeights(allRows);
    const rows = getFiltered().filter(r=>r.ticker===ticker);
    focusTicker = ticker; window.focusTicker = ticker;
    focusTitle.innerHTML = (function(){
  var nm = (NAME_MAP && NAME_MAP[ticker]) ? NAME_MAP[ticker] : '';
  var s  = tickerStyles(ticker||'');
  var T  = (ticker||'').toUpperCase();
  var initials = T.slice(0,2);
  return `
    <div class="td-name">
      <span class="avatar" data-ticker="${T}"><span class="mono">${initials}</span></span>
      <span class="ticker-pill gf-open" data-ticker="${T}" style="background:${s.bg};color:${s.fg}">${T}</span>
      ${nm ? `<span class="company">${nm}</span>` : ''}
    </div>`;
})();
    refreshFollowBtn();
    focusInfo.textContent = `${rows.length} transactions displayed for ${ticker}.`;
    focusBody.innerHTML='';
    rows.forEach(r=>{
      const dir=String(r.direction||'').toUpperCase();
      const tr=document.createElement('tr');
      tr.innerHTML = `
          <td>${fmtDateDMY(r.date||'')}</td>
          <td>${r.fund||''}</td>
        <td class="num ${dir==='BUY'?'buy':'sell'}">${fmtNum(r.shares)} | ${fmtPct(r.etf_percent)} <span class="arrow">${dir==='BUY'?'▲':'▼'}</span></td>
      `;
      focusBody.appendChild(tr);
    });
    overlay.style.display='flex';
    try{
      __logoResolver.hydrateAvatar('.hdr .avatar[data-ticker="'+ticker.toUpperCase()+'"]', ticker);
      setTimeout(()=>__logoResolver.hydrateAvatar('.hdr .avatar[data-ticker="'+ticker.toUpperCase()+'"]', ticker), 250);
      setTimeout(()=>__logoResolver.hydrateAvatar('.hdr .avatar[data-ticker="'+ticker.toUpperCase()+'"]', ticker), 800);
    }catch(e){}

  }

  
  function toggleMyTicker(ticker){
    let mine = getMyTickers();
    if(mine.includes(ticker)){
      mine = mine.filter(t=>t!==ticker);
    } else {
      mine.push(ticker);
    }
    setMyTickers(mine);
    render();
  }

  // Event handlers
  fetchBtn.onclick = fetchAll;
  
  const suggestionsBox = document.getElementById('suggestions');
  function hideSuggestions(){ suggestionsBox.style.display='none'; }
  function renderSuggestions(list){
    if(!list.length){ suggestionsBox.style.display='none'; return; }
    suggestionsBox.innerHTML = list.map(function(pair){
      var t = pair[0], n = pair[1] || '';
      var s = tickerStyles(t||'');
      return '<div class="sg" data-ticker="'+t+'">'
           +   '<span class="ticker-pill" style="background:'+s.bg+';color:'+s.fg+'">'+t+'</span>'
           +   '<span class="muted">'+n+'</span>'
           + '</div>';
    }).join('');
    // Attach to body to avoid any parent overflow clipping
    if (suggestionsBox.parentElement !== document.body){
      document.body.appendChild(suggestionsBox);
    }
    var r = searchBox.getBoundingClientRect();
    suggestionsBox.style.position = 'fixed';
    suggestionsBox.style.left = r.left + 'px';
    suggestionsBox.style.top = (r.bottom + 6) + 'px';
    suggestionsBox.style.minWidth = r.width + 'px';
    suggestionsBox.style.display='block';
  }
  function applySuggestion(t){
    searchBox.value = t;
    hideSuggestions();
    render();
  }
  // input handler
  searchBox.oninput = ()=>{
    const q = (searchBox.value||'').toLowerCase();
    if(!q){ hideSuggestions(); render(); return; }
    const suggestions = Object.entries(NAME_MAP)
      .filter(([t,n])=> t.toLowerCase().startsWith(q) || (n && n.toLowerCase().startsWith(q)))
      .slice(0,10);
    renderSuggestions(suggestions);
    render();
  };
  searchBox.addEventListener('keydown', (e)=>{
    if(e.key==='Escape'){ searchBox.value=''; hideSuggestions(); render(); return; }
    if(e.key==='Enter'){
      const qraw = (searchBox.value||'');
      const q = qraw.toLowerCase().trim();
      if(!q){ hideSuggestions(); render(); return; }
      const exactTicker = Object.keys(NAME_MAP).find(t => t.toLowerCase() === q);
      const exactName = Object.entries(NAME_MAP).find(([t,n]) => (n||'').toLowerCase() === q);
      if (exactTicker){ applySuggestion(exactTicker); e.preventDefault(); return; }
      if (exactName){ applySuggestion(exactName[0]); e.preventDefault(); return; }
      const suggestions = Object.entries(NAME_MAP)
        .filter(([t,n]) => t.toLowerCase().startsWith(q) || ((n||'').toLowerCase().startsWith(q)))
        .slice(0,10);
      if (suggestions.length){ applySuggestion(suggestions[0][0]); e.preventDefault(); return; }
      hideSuggestions(); render();
    }
  });
  // hide on Escape
  searchBox.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ searchBox.value=''; hideSuggestions(); render(); } });
  // hide on blur (with small delay to allow click on suggestion)
  searchBox.addEventListener('blur', ()=> setTimeout(hideSuggestions, 250));
  // hide on outside click
  suggestionsBox.addEventListener('mousedown', (e)=>{ var el = e.target.closest('[data-ticker]'); if(el){ applySuggestion(el.dataset.ticker); }});
  
  // === Suggestions: reposition on scroll/resize & robust close ===
  function repositionSuggestions(){
    if (!suggestionsBox || suggestionsBox.style.display === 'none') return;
    try{
      var r = searchBox.getBoundingClientRect();
      suggestionsBox.style.left = r.left + 'px';
      suggestionsBox.style.top = (r.bottom + 6) + 'px';
      suggestionsBox.style.minWidth = r.width + 'px';
    }catch(e){}
  }
  window.addEventListener('scroll', repositionSuggestions, true);
  window.addEventListener('resize', repositionSuggestions);
  document.addEventListener('keydown', function(e){ if(e.key==='Escape') hideSuggestions(); });
  // Click outside to close
  document.addEventListener('mousedown', function(e){
    if (suggestionsBox && suggestionsBox.style.display !== 'none'){
      const inside = e.target === suggestionsBox || suggestionsBox.contains(e.target) || e.target === searchBox;
      if(!inside) hideSuggestions();
    }
  });

  document.addEventListener('click', (e)=>{
    const sc = searchBox.closest('.search-card');
    if (!sc.contains(e.target)) hideSuggestions();
  });


  onlyMine.onchange = ()=>render();
  document.addEventListener('keydown', e=>{ if(e.key==='Escape') overlay.style.display='none'; });

  
// Delegated handler: open Google Finance when clicking any .gf-open (including in popup header)
document.addEventListener('click', function(e){
  var el = e.target.closest && e.target.closest('.gf-open');
  if(!el) return;
  var t = el.getAttribute('data-ticker') || el.textContent || '';
  if(!t) return;
  e.preventDefault(); e.stopPropagation();
  var url = (typeof googleFinanceURL==='function') ? googleFinanceURL(t) : ('https://www.google.com/finance/quote/'+t+':NASDAQ');
  window.open(url, '_blank', 'noopener');
}, true);


async function hydrateLogoInHeader(ticker){
  try{
    const T = (ticker||'').toUpperCase();
    const slot = document.querySelector('.hdr .avatar[data-ticker="'+T+'"]');
    if(!slot) return;
    const sources = [
      'logos/'+T+'.png',
      'https://static.finnhub.io/logo/'+T+'.png',
      'https://storage.googleapis.com/iex/api/logos/'+T+'.png'
    ];
    for (const src of sources){
      const ok = await new Promise((resolve)=>{ const img=new Image(); img.onload=()=>resolve(img.width>0); img.onerror=()=>resolve(false); img.src=src; });
      if (ok){ const imgEl=document.createElement('img'); imgEl.src=src; imgEl.alt=T; imgEl.style.width='100%'; imgEl.style.height='100%'; imgEl.style.objectFit='cover'; slot.innerHTML=''; slot.appendChild(imgEl); return; }
    }
  }catch(_){}
}


// === V7 — Shared logo resolver (home + popup) ===
(function(){
  const DOMAIN_MAP = {
    // Known tricky ones
    TEM: 'tempus.com',
    RBLX: 'roblox.com',
    SHOP: 'shopify.com',
    PLUG: 'plugpower.com',
    NVDA: 'nvidia.com',
    AMD: 'amd.com',
    TSLA: 'tesla.com',
    META: 'about.facebook.com',
    GOOGL: 'abc.xyz',
    GOOG: 'abc.xyz',
    MSFT: 'microsoft.com',
    ENI: 'eni.com'
  };

  const logoCache = new Map(); // TICKER -> resolved URL or null if none

  function fileCandidates(t){
    const T = (t||'').toUpperCase();
    const l = (t||'').toLowerCase();
    return [
      `logos/${T}.png`, `logos/${T}.svg`,
      `logos/${l}.png`, `logos/${l}.svg`
    ];
  }

  function cdnCandidates(t){
    const T = (t||'').toUpperCase();
    return [
      `https://static.finnhub.io/logo/${T}.png`,
      `https://storage.googleapis.com/iex/api/logos/${T}.png`
    ];
  }

  function faviconCandidates(t){
    const T = (t||'').toUpperCase();
    const dom = DOMAIN_MAP[T];
    if (!dom) return [];
    // Google s2 favicons (fast, reliable)
    return [
      `https://www.google.com/s2/favicons?domain=${dom}&sz=64`
    ];
  }

  async function probe(url){
    // Try to load image; resolve true on success, false on error
    try{
      const ok = await new Promise((resolve)=>{
        const img = new Image();
        img.onload = ()=>resolve(img.width>0);
        img.onerror = ()=>resolve(false);
        img.src = url;
      });
      return !!ok;
    }catch(_){ return false; }
  }

  async function resolveLogoFor(ticker){
    const T = (ticker||'').toUpperCase();
    if (logoCache.has(T)) return logoCache.get(T);
    const sources = [
  `logos/${T}.webp`, `Logos/${T}.webp`,
      ...fileCandidates(T),
      ...cdnCandidates(T),
      ...faviconCandidates(T)
    ];
    for (const src of sources){
      const ok = await probe(src);
      if (ok){ logoCache.set(T, src); return src; }
    }
    logoCache.set(T, null);
    return null;
  }

  async function hydrateAvatar(selector, ticker){
    const T = (ticker||'').toUpperCase();
    const slot = document.querySelector(selector);
    if (!slot) return;
    const found = await resolveLogoFor(T);
    if (!found) return; // keep initials
    const img = document.createElement('img');
    img.src = found;
    img.alt = T;
    img.style.width = '100%';
    img.style.height = '100%';
    img.style.objectFit = 'cover';
    slot.innerHTML = '';
    slot.appendChild(img);
  }

  // Expose minimal API
  window.__logoResolver = { resolveLogoFor, hydrateAvatar };
})();

  
// Bind click for Open Google Finance icon (robust)
(function(){
  function bindGF(){
    var btn = document.getElementById('openGFBtn');
    if(!btn) return;
    btn.onclick = function(){
      if(!window.focusTicker) return;
      var url = (typeof googleFinanceURL==='function')
        ? googleFinanceURL(focusTicker)
        : ('https://www.google.com/finance/quote/'+focusTicker+':NASDAQ');
      window.open(url, '_blank', 'noopener');
    };
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', bindGF);
  } else {
    bindGF();
  }
})();
  
// === V15 mount & stats ===
(function(){
  function move(id, slotId){
    const el = document.getElementById(id);
    const slot = document.getElementById(slotId);
    if (el && slot) slot.appendChild(el);
  }
  move('fromDate','slot-fromDate');
  move('toDate','slot-toDate');
  const sb = document.getElementById('searchBox');
  if (sb){
    const wrap = sb.closest('.search-inline') || sb;
    const slot = document.getElementById('slot-search'); if (wrap && slot) slot.appendChild(wrap);
  }
  move('fundsChips','slot-fundsChips');
  move('fetchBtn','slot-fetchBtn');
  move('csvBtn','slot-csvBtn');
  // === v4.18 — Arrange search actions + Clear behavior ===
  (function(){
    const $ = (id)=>document.getElementById(id);
    const slotSearch = $('slot-search');
    const slotCSV    = $('slot-csvBtn');
    const fetchBtn   = $('fetchBtn');
    const clearBtn   = $('clearBtn');
    const csvBtn     = $('csvBtn');
    const searchBox  = $('searchBox');

    // Place input + [Enter][X] inline in slot-search
    if (slotSearch && searchBox){
      const wrap = searchBox.closest('.search-inline') || searchBox;
      if (wrap && !slotSearch.contains(wrap)) slotSearch.appendChild(wrap);
      // ensure order: input, fetch, clear
      if (fetchBtn && !slotSearch.contains(fetchBtn)) slotSearch.appendChild(fetchBtn);
      if (clearBtn && !slotSearch.contains(clearBtn)) { /* already inside search-wrap */ }
      // if csv accidentally sits here, move it out
      if (csvBtn && slotSearch.contains(csvBtn) && slotCSV){ slotCSV.appendChild(csvBtn); }
    }
    // CSV stays below in its own slot
    if (csvBtn && slotCSV && !slotCSV.contains(csvBtn)) slotCSV.appendChild(csvBtn);

    // Placeholder simplified
    if (searchBox) searchBox.placeholder = 'e.g. NVDA';

    // Clear should emulate manual clearing (no refetch): empty + dispatch input
    if (clearBtn && searchBox){
      clearBtn.addEventListener('click', ()=>{
        searchBox.value = '';
        // Dispatch input event to trigger same filtering/render of key typing
        try{
          const evt = new Event('input', { bubbles: true });
          searchBox.dispatchEvent(evt);
        }catch(e){
          // Fallback for older browsers
          const evt2 = document.createEvent('Event');
          evt2.initEvent('input', true, true);
          searchBox.dispatchEvent(evt2);
        }
        searchBox.focus();
      });
    }
  })();



  // v4.19.1 — remove duplicate Clear buttons outside search-wrap (keep only the inside one)
  (function(){
    const all = Array.from(document.querySelectorAll('#clearBtn'));
    if (all.length > 1){
      all.forEach(btn => {
        if (!btn.closest('.search-wrap')) {
          btn.remove();
        }
      });
    }
  })();


  // v4.19.2 — Remove Export CSV button entirely
  (function(){
    const csv = document.getElementById('csvBtn');
    if (csv) csv.remove();
    const slot = document.getElementById('slot-csvBtn');
    if (slot) slot.remove();
  })();

  // Move Results section into resultsSlot
  const resultsSlot = document.getElementById('resultsSlot');
  const tbl = document.getElementById('table');
  if (tbl && resultsSlot){
    const section = tbl.closest('section.card.pad') || tbl.closest('section') || tbl.parentElement;
    if (section) resultsSlot.appendChild(section);
  }

  // Stats update: wrap render()
  if (typeof render === 'function'){
    const _render = render;
    window.render = function(){
      _render();
      try{
        const list = (typeof getFiltered==='function') ? getFiltered() : [];
        const total = list.length;
        const buys  = list.filter(r => String(r.direction||'').toUpperCase()==='BUY').length;
        const sells = list.filter(r => String(r.direction||'').toUpperCase()==='SELL').length;
        const pct = (n)=> total? Math.round((n/total)*1000)/10 : 0;
        const $ = (id)=> document.getElementById(id);
        if($('statTotalN')) $('statTotalN').textContent = (total||0).toLocaleString('it-IT');
        if($('statBuyN'))   $('statBuyN').textContent   = (buys||0).toLocaleString('it-IT');
        if($('statSellN'))  $('statSellN').textContent  = (sells||0).toLocaleString('it-IT');
        if($('statBuyPct'))  $('statBuyPct').textContent  = (pct(buys)).toFixed(1).replace('.0','') + '%';
        if($('statSellPct')) $('statSellPct').textContent = (pct(sells)).toFixed(1).replace('.0','') + '%';
      }catch(e){}
    };
    try{ render(); }catch(e){}
  }
})();

  
// === V16: bookmark toggle + robust stats updater ===
(function(){
  // Recreate hidden onlyMine checkbox if missing (keeps existing filtering logic)
  var onlyMine = document.getElementById('onlyMine');
  if (!onlyMine){
    onlyMine = document.createElement('input');
    onlyMine.type='checkbox'; onlyMine.id='onlyMine'; onlyMine.style.display='none';
    document.body.appendChild(onlyMine);
  }

  // Wire bookmark toggle
  var toggleBtn = document.getElementById('toggleMineBtn');
  function syncToggleUI(){
    if(!toggleBtn) return;
    var on = !!onlyMine.checked;
    toggleBtn.classList.toggle('on', on);
    toggleBtn.title = on ? 'Showing only my tickers' : 'Only my tickers';
  }
  if (toggleBtn){
    toggleBtn.addEventListener('click', function(){
      onlyMine.checked = !onlyMine.checked;
      syncToggleUI();
      try{ render(); }catch(e){}
    });
    syncToggleUI();
  }

  // Stats updater
  function updateStats(){
    try{
      var list = (typeof getFiltered==='function') ? getFiltered() : (window.allRows || []);
      var total = list.length;
      var buys  = list.filter(function(r){ return String(r.direction||'').toUpperCase()==='BUY'; }).length;
      var sells = list.filter(function(r){ return String(r.direction||'').toUpperCase()==='SELL'; }).length;
      var pct = function(n){ return total ? Math.round((n/total)*1000)/10 : 0; };
      var $ = function(id){ return document.getElementById(id); };
      if($('statTotalN')) $('statTotalN').textContent = (total||0).toLocaleString('it-IT');
      if($('statBuyN'))   $('statBuyN').textContent   = (buys||0).toLocaleString('it-IT');
      if($('statSellN'))  $('statSellN').textContent  = (sells||0).toLocaleString('it-IT');
      if($('statBuyPct'))  $('statBuyPct').textContent  = (pct(buys)).toFixed(1).replace('.0','') + '%';
      if($('statSellPct')) $('statSellPct').textContent = (pct(sells)).toFixed(1).replace('.0','') + '%';
    }catch(e){}
  }

  // Wrap render() so every change updates stats
  if (typeof render === 'function'){
    var _render = render;
    window.render = function(){
      _render();
      updateStats();
    };
  }

  // Also observe table body changes to refresh stats when data loads
  var tbody = document.querySelector('#table tbody');
  if (tbody && 'MutationObserver' in window){
    var obs = new MutationObserver(updateStats);
    obs.observe(tbody, {childList:true, subtree:false});
  }

  // Initial attempt (in case data is already there)
  setTimeout(updateStats, 50);
  setTimeout(updateStats, 400);
  setTimeout(updateStats, 1200);
})();

  
// === V25: mount into two fixed columns (left: filters+stats, right: results) ===
document.addEventListener('DOMContentLoaded', function(){
  function byId(id){ return document.getElementById(id); }
  var twoCol   = byId('twoCol');
  var leftCol  = byId('leftCol');
  var rightCol = byId('rightCol');
  if (!twoCol || !leftCol || !rightCol) return;

  // Move Search Filters card into leftCol
  var filterCard = byId('filterCard');
  if (!filterCard){
    // If it's still inside the hidden controls section, move that first
    var controls = document.querySelector('section.controls.grid.fit-240');
    if (controls){
      // try to find filter card inside; fallback: build a new left card from existing slots
      filterCard = controls.querySelector('#filterCard') || null;
    }
  }
  if (filterCard){ leftCol.appendChild(filterCard); }

  // Move stats row under filters (left column)
  var stats = byId('statsRow');
  if (stats){ leftCol.appendChild(stats); }

  // Move the Results section into rightCol
  var tbl = byId('table');
  var resultsSection = tbl ? (tbl.closest('section.card.pad') || tbl.closest('section') || tbl.parentElement) : null;
  if (resultsSection){ rightCol.appendChild(resultsSection); }

  // Bookmark toggle -> hidden checkbox
  var only = byId('onlyMine');
  if(!only){ only = document.createElement('input'); only.type='checkbox'; only.id='onlyMine'; only.style.display='none'; document.body.appendChild(only); }
  var btn = byId('toggleMineBtn');
  function sync(){ if(btn) btn.classList.toggle('on', !!only.checked); }
  if (btn){
    btn.addEventListener('click', function(){ only.checked = !only.checked; sync(); try{ render(); }catch(e){}; });
    sync();
  }

  // Funds "Selected: N" mirror from chip states
  function updateFundMirror(){
    try{
      var root = byId('slot-fundsChips') || byId('fundsChips');
      var mirror = byId('fundCountMirror');
      if (!root || !mirror) return;
      var n = root.querySelectorAll('.chip.on').length;
      mirror.textContent = String(n);
    }catch(e){}
  }
  updateFundMirror();
  document.body.addEventListener('click', function(ev){
    var t = ev.target;
    if (t && t.closest && (t.closest('#slot-fundsChips') || t.closest('#fundsChips'))){
      setTimeout(updateFundMirror, 10);
    }
  });
  if (typeof render === 'function'){
    var _render = render;
    window.render = function(){
      _render();
      updateFundMirror();
      try{
        var list = (typeof getFiltered==='function') ? getFiltered() : [];
        var total = list.length;
        var buys  = list.filter(r => String(r.direction||'').toUpperCase()==='BUY').length;
        var sells = list.filter(r => String(r.direction||'').toUpperCase()==='SELL').length;
        var pct   = function(n){ return total? Math.round((n/total)*1000)/10 : 0; };
        var $ = function(id){ return document.getElementById(id); };
        if($('statTotalN')) $('statTotalN').textContent = (total||0).toLocaleString('it-IT');
        if($('statBuyN'))   $('statBuyN').textContent   = (buys||0).toLocaleString('it-IT');
        if($('statSellN'))  $('statSellN').textContent  = (sells||0).toLocaleString('it-IT');
        if($('statBuyPct'))  $('statBuyPct').textContent  = (pct(buys)).toFixed(1).replace('.0','') + '%';
        if($('statSellPct')) $('statSellPct').textContent = (pct(sells)).toFixed(1).replace('.0','') + '%';
      }catch(e){}
    };
  }
});

  
// === V28 runtime: disable funds filtering & keep everything else working ===
document.addEventListener('DOMContentLoaded', function(){
  // If there's any funds chips container, remove it from DOM
  var fc = document.getElementById('fundsChips') || document.getElementById('slot-fundsChips');
  if (fc){ var parent = fc.closest('.card') || fc.parentElement; if (parent) parent.remove(); else fc.remove(); }

  // Create/override a helper that always returns ALL funds present in data
  window.getEnabledFunds = function(){
    try{
      var all = (window.allRows||[]).map(r=>r.fund);
      return Array.from(new Set(all));
    }catch(e){ return []; }
  };

  // Monkey-patch getFiltered to ignore any fund selection it might use
  if (typeof getFiltered === 'function'){
    const _getFiltered = getFiltered;
    window.getFiltered = function(){
      // call original
      const out = _getFiltered();
      // If the original already ignores funds, return as-is.
      // Otherwise, if it filtered by a subset of funds, we can't easily detect here;
      // but we can ensure that a global set isn't restricting future renders by resetting it if present.
      try{
        if (window.selectedFunds && typeof window.selectedFunds.clear === 'function'){
          // rebuild as "all funds"
          window.selectedFunds.clear();
          (window.allRows||[]).forEach(r => window.selectedFunds.add(r.fund));
        }
      }catch(_){}
      return out;
    };
  }

  // Also ensure chip count/mirror is gone
  var mirror = document.getElementById('fundCountMirror'); if (mirror) mirror.parentElement && mirror.parentElement.remove();
});

  // Auto-caricamento all'apertura
  window.addEventListener('DOMContentLoaded', fetchAll);

  // Ticker color helper (placed last so it's defined when sidebar uses it)
  function tickerColorExample(){ return null; }
})();

</script>

<script>
// === Auto-resolve exchange with persistent overrides ===
(function(){
  // Hardcoded seeds (best-effort) for first-run guesses
  const SEED = {
    // Likely NASDAQ
    AMD:'NASDAQ', GOOGL:'NASDAQ', GOOG:'NASDAQ', AMZN:'NASDAQ', META:'NASDAQ',
    NVDA:'NASDAQ', INTC:'NASDAQ', ROKU:'NASDAQ', CRSP:'NASDAQ', NTLA:'NASDAQ',
    SNPS:'NASDAQ', MSFT:'NASDAQ', TSLA:'NASDAQ', PLUG:'NASDAQ', ABSI:'NASDAQ',
    TEM:'NASDAQ', REKR:'NASDAQ', HYMC:'NASDAQ', QSI:'NASDAQ', ISRG:'NASDAQ',
    ARCT:'NASDAQ', PACB:'NASDAQ', FCEL:'NASDAQ', AAPL:'NASDAQ', NFLX:'NASDAQ',
    // Known NYSE from your list
    PATH:'NYSE', ORCL:'NYSE', PLTR:'NYSE', UNH:'NYSE', TDY:'NYSE',
    // Specific fixes
    LHX:'NYSE', BABA:'NYSE', RBLX:'NYSE', SHOP:'NASDAQ', ENI:'NYSE'
  };
  const KEY = 'exchange_overrides_v1';

  function loadMap(){
    try{ return JSON.parse(localStorage.getItem(KEY) || '{}'); }catch(_){ return {}; }
  }
  function saveMap(m){ localStorage.setItem(KEY, JSON.stringify(m)); }
  function setExchange(t, ex){
    const T = (t||'').toUpperCase();
    const m = loadMap();
    m[T] = ex;
    saveMap(m);
  }
  window.__setExchangeOverride = setExchange;

  function resolveExchange(t){
    const T = (t||'').toUpperCase();
    const m = loadMap();
    if (m[T]) return m[T];
    if (SEED[T]) return SEED[T];
    return 'NASDAQ'; // fallback
  }
  // Patch/define googleFinanceURL to use the resolver
  const _oldGF = (typeof googleFinanceURL === 'function') ? googleFinanceURL : null;
  window.googleFinanceURL = function(t){
    const T = (t||'').toUpperCase();
    const exch = resolveExchange(T);
    const enc = encodeURIComponent(T);
    return `https://www.google.com/finance/quote/${enc}:${exch}`;
  };

  // Add a small dropdown in the overlay header next to "Go to stock" to change exchange quickly
  function enhanceOverlay(){
    const hdr = document.querySelector('#focusHeader') || document.querySelector('.focus-header') || document.querySelector('#focus .header, #focus header');
    if (!hdr || hdr.__exchEnhanced) return;
    hdr.__exchEnhanced = true;

    const wrap = document.createElement('span');
    wrap.style.marginLeft = '8px';
    wrap.innerHTML = `
      <select id="exchSelect" style="background:transparent;border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:6px 8px;color:#ddd;outline:none">
        <option value="NASDAQ">NASDAQ</option>
        <option value="NYSE">NYSE</option>
        <option value="AMEX">AMEX</option>
        <option value="OTC">OTC</option>
      </select>`;
    hdr.appendChild(wrap);

    // When overlay opens, set select to current ticker's exch
    const setForTicker = (t)=>{
      const sel = document.getElementById('exchSelect'); if (!sel) return;
      sel.value = resolveExchange(t);
      sel.onchange = ()=>{
        __setExchangeOverride(t, sel.value);
      };
    };

    // Hook into openFocus to update dropdown
    if (!window.__openFocusPatched){
      window.__openFocusPatched = true;
      const __oldOpen = window.openFocus;
      window.openFocus = function(t){
        const res = __oldOpen ? __oldOpen.apply(this, arguments) : undefined;
        setTimeout(()=> setForTicker(t), 0);
        return res;
      };
    }
  }

  // Try now and observe DOM changes
  function run(){
    enhanceOverlay();
  }
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', run);
  } else {
    run();
  }
  const mo = new MutationObserver(run);
  mo.observe(document.documentElement, {childList:true, subtree:true});
})();
</script>

<script>

// === v4.12 — Ticker avatar helpers (hybrid: local -> clearbit -> monogram) ===
(function(){
  const DOMAIN_MAP = {
    AMD:'amd.com', NVDA:'nvidia.com', INTC:'intel.com', MSFT:'microsoft.com',
    META:'meta.com', GOOGL:'abc.xyz', GOOG:'abc.xyz', AMZN:'amazon.com',
    AAPL:'apple.com', TSLA:'tesla.com', ORCL:'oracle.com', SNPS:'synopsys.com',
    UNH:'unitedhealthgroup.com', ENI:'eni.com', PLUG:'plugpower.com',
    RBLX:'roblox.com', ROKU:'roku.com', BABA:'alibaba.com', SHOP:'shopify.com',
    PLTR:'palantir.com', PATH:'uipath.com', ARCT:'arcturusrx.com',
    CRSP:'crisprtx.com', NTLA:'intelliatx.com', ABSI:'absci.com',
    TEM:'tempus.com', BBAI:'bigbear.ai', REKR:'rekor.ai',
    HIVE:'hivedigitaltechnologies.com', HYMC:'hycroftmining.com',
    QSI:'quantum-si.com', ISRG:'intuitive.com', TDY:'teledyne.com',
    FCEL:'fce.com', PACB:'pacb.com'
  };

  function createAvatar(ticker){
  const T = (ticker||'').toUpperCase();
  const span = document.createElement('span');
  span.className = 'avatar';
  const img = document.createElement('img');

  // Try multiple local candidates (folder case + extensions)
  const candidates = [
    `logos/${T}.webp`, `Logos/${T}.webp`,
    `logos/${T}.svg`, `Logos/${T}.svg`,
    `logos/${T}.png`, `Logos/${T}.png`,
    `logos/${T}.jpg`, `Logos/${T}.jpg`,
    `logos/${T}.jpeg`, `Logos/${T}.jpeg`
  ];

  // If we have a domain, add Clearbit fallback at the end
  const clearbitURL = DOMAIN_MAP[T] ? `https://logo.clearbit.com/${DOMAIN_MAP[T]}?size=64` : null;
  if (clearbitURL) candidates.push(clearbitURL);

  let idx = 0;
  img.onerror = () => {
    idx++;
    if (idx < candidates.length){
      img.src = candidates[idx];
    } else {
      span.innerHTML = `<span class="mono">${T.slice(0,2)}</span>`;
    }
  };
  img.src = candidates[idx];
  span.appendChild(img);
  return span;
}

  function enhanceRow(tr){
    if (!tr || tr.__avatarEnhanced) return;
    tr.__avatarEnhanced = true;
    try{
      const t = tr.getAttribute('data-ticker') || '';
      if (!t) return;
      const tds = tr.querySelectorAll('td');
      if (tds.length < 3) return;
      const nameCell = tds[2];
      nameCell.classList.add('td-name');
      if (nameCell.querySelector('.avatar')) return;
      const avatar = createAvatar(t);
      nameCell.insertBefore(avatar, nameCell.firstChild);
      if (!nameCell.querySelector('.ticker-wrap')){
        const wrap = document.createElement('span');
        wrap.className = 'ticker-wrap';
        while (avatar.nextSibling) wrap.appendChild(avatar.nextSibling);
        nameCell.appendChild(wrap);
      }
    }catch(e){}
  }

  function enhanceTable(){
    const tbody = document.querySelector('#table tbody');
    if (!tbody) return;
    tbody.querySelectorAll('tr').forEach(enhanceRow);
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', enhanceTable);
  } else {
    enhanceTable();
  }
  const mo = new MutationObserver(muts=>{
    for (const m of muts){
      m.addedNodes && m.addedNodes.forEach(n=>{
        if (n.nodeType===1 && n.matches && n.matches('#table tbody tr')) enhanceRow(n);
        if (n.querySelectorAll){
          n.querySelectorAll('#table tbody tr').forEach(enhanceRow);
        }
      });
    }
  });
  mo.observe(document.body, {childList:true, subtree:true});
// === Lightweight DOM-side filter & pagination (non-invasive) ===
try{
  const typeFilter = document.getElementById('typeFilter');
  const pageSizeSel = document.getElementById('pageSize');
  const prevPageBtn = document.getElementById('prevPage');
  const nextPageBtn = document.getElementById('nextPage');
  const pageInfoEl  = document.getElementById('pageInfo');
  const countBoxEl  = document.getElementById('countBox');
  const tbodyEl     = document.getElementById('tbody');
  let currentPage = 1;
  let pageSize = pageSizeSel ? parseInt(pageSizeSel.value,10) : 100;

  function rowDir(tr){
    // dir inferred from last cell class (has 'buy' or 'sell')
    const td = tr.querySelector('td:last-child');
    if (!td) return 'ALL';
    return td.classList.contains('buy') ? 'BUY' : (td.classList.contains('sell') ? 'SELL' : 'ALL');
  }

  function visibleRows(){
    const tSel = (typeFilter && typeFilter.value) ? typeFilter.value.toUpperCase() : 'ALL';
    const rows = Array.from(tbodyEl.querySelectorAll('tr'));
    const filt = rows.filter(tr => {
      const d = rowDir(tr);
      return (tSel==='ALL' || d===tSel);
    });
    // update count to visible rows
    if (countBoxEl) countBoxEl.textContent = filt.length.toLocaleString('it-IT');
    return filt;
  }

  function applyPager(){
    if (!tbodyEl) return;
    const rows = visibleRows();
    const pages = Math.max(1, Math.ceil(rows.length / pageSize));
    if (currentPage > pages) currentPage = pages;
    const start = (currentPage-1)*pageSize;
    const end   = start + pageSize;

    // First hide all
    Array.from(tbodyEl.querySelectorAll('tr')).forEach(tr => tr.style.display = 'none');
    // Then show filtered slice
    rows.slice(start, end).forEach(tr => tr.style.display = '');

    if (pageInfoEl) pageInfoEl.textContent = `Page ${pages ? currentPage : 1} / ${Math.max(pages,1)}`;
    if (prevPageBtn) prevPageBtn.disabled = (currentPage<=1);
    if (nextPageBtn) nextPageBtn.disabled = (currentPage>=pages);
  }

  if (typeFilter) typeFilter.addEventListener('change', ()=>{ currentPage=1; applyPager(); });
  if (pageSizeSel) pageSizeSel.addEventListener('change', ()=>{ pageSize=parseInt(pageSizeSel.value,10)||100; currentPage=1; applyPager(); });
  if (prevPageBtn) prevPageBtn.addEventListener('click', ()=>{ currentPage=Math.max(1,currentPage-1); applyPager(); });
  if (nextPageBtn) nextPageBtn.addEventListener('click', ()=>{ currentPage=currentPage+1; applyPager(); });

  // Re-apply after any table re-render
  const mo = new MutationObserver(()=>{ currentPage=1; applyPager(); });
  if (tbodyEl) mo.observe(tbodyEl, {childList:true, subtree:false});

  // Initial
  setTimeout(applyPager, 0);
}catch(e){ console.error('Pager init error', e); }
// === Bottom pager wiring (duplicate controls) ===
try{
  const prevTop = document.getElementById('prevPage');
  const nextTop = document.getElementById('nextPage');
  const infoTop = document.getElementById('pageInfo');
  const prevBottom = document.getElementById('prevPageBottom');
  const nextBottom = document.getElementById('nextPageBottom');
  const infoBottom = document.getElementById('pageInfoBottom');

  if (prevBottom && prevTop) prevBottom.addEventListener('click', ()=> prevTop.click());
  if (nextBottom && nextTop) nextBottom.addEventListener('click', ()=> nextTop.click());

  // Keep bottom info mirrored with top info
  if (infoTop && infoBottom){
    const mo = new MutationObserver(()=>{ infoBottom.textContent = infoTop.textContent; });
    mo.observe(infoTop, {characterData:true, subtree:true, childList:true});
    // initial sync
    infoBottom.textContent = infoTop.textContent;
  }
}catch(e){ console.error('Bottom pager sync error', e); }
// === Stat-cards drive Trade filter (Total / Buy / Sell) ===
try{
  const typeSel = document.getElementById('typeFilter');
  const cardTotal = document.getElementById('statTotalN') ? document.getElementById('statTotalN').closest('.stat-card') : null;
  const cardBuy   = document.getElementById('statBuyN') ? document.getElementById('statBuyN').closest('.stat-card') : null;
  const cardSell  = document.getElementById('statSellN') ? document.getElementById('statSellN').closest('.stat-card') : null;

  function setActive(mode){
    [cardTotal, cardBuy, cardSell].forEach(c => c && c.classList.remove('active'));
    if (mode==='ALL' && cardTotal) cardTotal.classList.add('active');
    if (mode==='BUY' && cardBuy)   cardBuy.classList.add('active');
    if (mode==='SELL' && cardSell) cardSell.classList.add('active');
  }
  function setMode(mode){
    if (typeSel){
      typeSel.value = mode;
      typeSel.dispatchEvent(new Event('change'));
    } else {
      // fallback: force re-render/pager
      if (typeof applyPager === 'function') applyPager();
      else if (typeof render === 'function') render();
    }
    setActive(mode);
  }

  if (cardTotal) cardTotal.addEventListener('click', ()=> setMode('ALL'));
  if (cardBuy)   cardBuy.addEventListener('click',  ()=> setMode('BUY'));
  if (cardSell)  cardSell.addEventListener('click', ()=> setMode('SELL'));

  // initial: reflect current select value
  setActive(typeSel && typeSel.value ? typeSel.value.toUpperCase() : 'ALL');
}catch(e){ console.error('Stat-card filter binding error', e); }
})();

</script>



<script>
/* === Close & Total Column Enhancer v2.2 (stable) ===
   - Inserisce le colonne Close e Total PRIMA di Shares senza spostare i dati esistenti
   - Usa mappa INDICI "pre-inserimento" per allineare correttamente le nuove celle
   - Close 70px con simbolo $, Total 90px con formato compatto (K/M/B/T) e punto decimale
*/
(function(){
  const TABLE_ID = 'table';
  const TBODY_ID = 'tbody';
  const MAX_CONCURRENCY = 3;

  // Snapshot degli indici PRIMA di qualsiasi modifica
  let originalIndexMap = null; // {dateIdx, sharesIdx, tickerIdx, thEls, theadRow}

  // Utils
  const DAY = 24*60*60*1000;
  const pad = (n)=> String(n).padStart(2,'0');
  const toISO = (y,m,d)=> `${y}-${pad(m)}-${pad(d)}`;

  function parseDDMMYY(s){
    if(!s) return null;
    const m = s.trim().match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
    if(!m) return null;
    let [_, dd, mm, yy] = m;
    dd = parseInt(dd,10);
    mm = parseInt(mm,10);
    yy = parseInt(yy,10);
    if(yy < 100){ yy += 2000; }
    return toISO(yy,mm,dd);
  }

  function parseShares(text){
    if(!text) return null;
    let s = text.replace(/[^0-9,\.\-]/g,'');
    if (s.includes(',') && s.includes('.')) {
      s = s.replace(/\./g,'').replace(',', '.');
    } else if (s.includes(',') && !s.includes('.')) {
      s = s.replace(/,/g, '');
    }
    const v = parseFloat(s);
    return Number.isFinite(v) ? v : null;
  }

  function formatCompact(n){
    if(n==null || !Number.isFinite(n)) return '–';
    const abs = Math.abs(n);
    const sign = n < 0 ? '-' : '';
    const units = [
      {v:1e12, s:'T'},
      {v:1e9,  s:'B'},
      {v:1e6,  s:'M'},
      {v:1e3,  s:'K'}
    ];
    for(const u of units){
      if(abs >= u.v){
        return sign + (abs/u.v).toFixed(2) + ' ' + u.s;
      }
    }
    return sign + Math.round(abs).toString();
  }

  // Yahoo helpers
  function buildYahooURL(symbol, startMs, endMs){
    const p1 = Math.floor(startMs/1000);
    const p2 = Math.floor(endMs/1000) + 86400;
    return `https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(symbol)}?period1=${p1}&period2=${p2}&interval=1d&events=history&includeAdjustedClose=true`;
  }
  async function fetchWithFallback(rawUrl){
    const urls = [
      rawUrl,
      `https://corsproxy.io/?${encodeURIComponent(rawUrl)}`,
      `https://api.allorigins.win/raw?url=${encodeURIComponent(rawUrl)}`
    ];
    let lastErr;
    for(const u of urls){
      try{
        const res = await fetch(u, {cache:'no-store'});
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      }catch(e){ lastErr = e; }
    }
    throw lastErr || new Error('Fetch fallito su tutte le rotte');
  }

  const priceCache = new Map();
  const queue = [];
  let running = 0;
  function enqueue(task){ queue.push(task); pump(); }
  async function pump(){
    while(running < MAX_CONCURRENCY && queue.length){
      const t = queue.shift();
      running++;
      try{ await t(); }finally{ running--; }
    }
  }

  async function getClosePrice(symbol, isoDate){
    const key = `${symbol}|${isoDate}`;
    if(priceCache.has(key)) return priceCache.get(key);
    const end = new Date(isoDate);
    const start = new Date(end.getTime() - 10*DAY);
    try{
      const data = await fetchWithFallback(buildYahooURL(symbol, start.getTime(), end.getTime()));
      const r = data?.chart?.result?.[0];
      const ts = r?.timestamp || [];
      const closes = r?.indicators?.adjclose?.[0]?.adjclose || r?.indicators?.quote?.[0]?.close || [];
      let last = null;
      for(let i=0;i<ts.length;i++){
        const t = new Date(ts[i]*1000);
        if (t <= end && Number.isFinite(closes[i])) last = closes[i];
      }
      if(last!=null) priceCache.set(key, last);
      return last;
    }catch(e){ return null; }
  }

  // === Header mapping (snapshot BEFORE insertion) ===
  function mapHeaderIndices(){
    const theadRow = document.querySelector('#' + TABLE_ID + ' thead tr');
    if(!theadRow) return {};
    const thEls = [...theadRow.querySelectorAll('th')];
    const labels = thEls.map(th=> (th.textContent||'').trim().toLowerCase());
    const dateIdx = labels.findIndex(t=> t.startsWith('date'));
    const sharesIdx = labels.findIndex(t=> t.includes('shares'));
    let tickerIdx = labels.findIndex(t=> t.includes('ticker'));
    if (tickerIdx === -1) { tickerIdx = labels.findIndex(t=> t.includes('name') || t.includes('company')); }
    return { dateIdx, sharesIdx, tickerIdx, thEls, theadRow };
  }

  // Insert headers BEFORE Shares using ORIGINAL sharesIdx
  function ensureHeader(){
    const table = document.getElementById(TABLE_ID);
    if(!table) return;
    const colgroup = table.querySelector('colgroup');

    if(!originalIndexMap){
      originalIndexMap = mapHeaderIndices(); // snapshot
    }
    const { sharesIdx, theadRow, thEls } = originalIndexMap;
    if(!theadRow || sharesIdx === -1) return;

    // Already present?
    const existsClose = theadRow.querySelector('th.close-col');
    const existsTotal = theadRow.querySelector('th.total-col');
    if (existsClose && existsTotal) return;

    const thClose = document.createElement('th');
    thClose.textContent = 'Close';
    thClose.className = 'num close-col';
    const thTotal = document.createElement('th');
    thTotal.textContent = 'Total';
    thTotal.className = 'num total-col';

    const refNode = thEls[sharesIdx] || null; // BEFORE original Shares
    theadRow.insertBefore(thTotal, refNode);
    theadRow.insertBefore(thClose, thTotal);

    if(colgroup){
      const cols = [...colgroup.querySelectorAll('col')];
      const colClose = document.createElement('col'); colClose.setAttribute('style','width:70px');
      const colTotal = document.createElement('col'); colTotal.setAttribute('style','width:90px');
      const cgRef = cols[sharesIdx] || null;
      colgroup.insertBefore(colTotal, cgRef);
      colgroup.insertBefore(colClose, colTotal);
    }
  }

  // Extract info using ORIGINAL indices (robusto a riordino)
  function extractRowInfo(tr){
    if(!originalIndexMap){ originalIndexMap = mapHeaderIndices(); }
    const { dateIdx, sharesIdx, tickerIdx } = originalIndexMap;
    if(dateIdx === -1) return null;
    const tds = tr.cells;
    if(!tds || tds.length === 0) return null;

    const isoDate = parseDDMMYY(tds[dateIdx]?.textContent?.trim() || '');
    const shares = (sharesIdx !== -1 && tds[sharesIdx]) ? parseShares(tds[sharesIdx].textContent || '') : null;

    // Ticker
    let ticker = null;
    const nameCell = (tickerIdx >=0 && tds[tickerIdx]) ? tds[tickerIdx] : tds[Math.min(tds.length-1, 2)];
    if(nameCell){
      const pill = nameCell.querySelector('.ticker-pill');
      if(pill){
        const txt = (pill.textContent || '').trim();
        if(txt) ticker = txt.replace(/[^A-Z0-9\.-]/g,'').toUpperCase();
      }
      if(!ticker){
        const txt = (nameCell.textContent || '').trim();
        const m = txt.match(/\b[A-Z]{1,6}(?:\.[A-Z]{1,2}|-[A-Z]{1,3})?\b/);
        if(m) ticker = m[0].toUpperCase();
      }
    }
    if(!isoDate || !ticker) return null;
    return { isoDate, shares, ticker };
  }

  // Ensure new cells exist BEFORE the ORIGINAL Shares cell
  function ensureCells(tr){
    if(tr.querySelector('td.close-cell') && tr.querySelector('td.total-cell')) return;
    if(!originalIndexMap){ originalIndexMap = mapHeaderIndices(); }
    const { sharesIdx } = originalIndexMap;
    const tds = tr.cells;
    const insertPos = (sharesIdx === -1) ? tds.length : sharesIdx; // before original Shares
    const refNode = tds[insertPos] || null;

    const tdClose = document.createElement('td');
    tdClose.className = 'num close-cell';
    tdClose.textContent = '…';
    const tdTotal = document.createElement('td');
    tdTotal.className = 'num total-cell';
    tdTotal.textContent = '…';

    tr.insertBefore(tdTotal, refNode);
    tr.insertBefore(tdClose, tdTotal);
  }

  function populate(tr){
    ensureCells(tr);
    const info = extractRowInfo(tr);
    const tdClose = tr.querySelector('td.close-cell');
    const tdTotal = tr.querySelector('td.total-cell');
    if(!info){
      if(tdClose) tdClose.textContent = '–';
      if(tdTotal) tdTotal.textContent = '–';
      return;
    }
    enqueue(async () => {
      const px = await getClosePrice(info.ticker, info.isoDate);
      if(tdClose) tdClose.textContent = (px!=null) ? ('$' + Number(px).toFixed(2)) : '–';
      if(tdTotal){
        if(px!=null && Number.isFinite(info.shares)){
          tdTotal.textContent = formatCompact(px * info.shares);
        }else{
          tdTotal.textContent = '–';
        }
      }
    });
  }

  function processAll(){
    ensureHeader();
    const tbody = document.getElementById(TBODY_ID);
    if(!tbody) return;
    [...tbody.querySelectorAll('tr')].forEach(populate);
  }

  function observe(){
    const tbody = document.getElementById(TBODY_ID);
    if(!tbody) return;
    const obs = new MutationObserver((mutations)=>{
      for(const m of mutations){
        if(m.type === 'childList' && m.addedNodes?.length){
          m.addedNodes.forEach(n=>{
            if(n.nodeType===1 && n.tagName==='TR') populate(n);
          });
        }
      }
    });
    obs.observe(tbody, { childList:true });
  }

  window.addEventListener('load', function(){
    try{
      // snapshot header before touching it
      originalIndexMap = mapHeaderIndices();
      ensureHeader();
      processAll();
      observe();
    }catch(e){ /* no-op */ }
  });
})();
</script>


<script>
/* === Totals Calculator v1.1 (x1000) — non‑destructive ===
   - NON sposta/aggiunge colonne.
   - Calcola: Total = (Close × Shares) * 1000
   - Abbreviazione K/M/B/T con punto decimale.
*/
(function(){
  const TABLE_ID = 'table';
  const TBODY_ID = 'tbody';

  function headerMap(){
    const thead = document.querySelector('#'+TABLE_ID+' thead');
    const row = thead ? thead.querySelector('tr') : null;
    const ths = row ? Array.from(row.children) : [];
    const labels = ths.map(th => (th.textContent || '').trim().toLowerCase());
    const idx = {
      close:  labels.findIndex(t => t === 'close'),
      total:  labels.findIndex(t => t === 'total'),
      shares: labels.findIndex(t => t.includes('shares')), // "Shares | %"
    };
    return { row, ths, labels, ...idx };
  }

  function parseClose(text){
    if(!text) return null;
    let s = String(text).replace(/\$/g,'').replace(/[ \u00A0,]/g,'');
    s = s.replace(/[^0-9.\-]/g,'');
    if(!s || s==='.' || s==='-' || s==='-.') return null;
    const v = parseFloat(s);
    return Number.isFinite(v) ? v : null;
  }

  function parseShares(text){
    if(!text) return null;
    // Usa solo la parte a sinistra di '|'
    let s = String(text).split('|')[0];
    s = s.replace(/[ \u00A0]/g,''); // spazi
    s = s.replace(/,/g,'');        // virgole come migliaia
    s = s.replace(/[^0-9.\-]/g,''); // tieni solo cifre, punto, segno
    if(!s || s==='.' || s==='-' || s==='-.') return null;
    const v = parseFloat(s);
    return Number.isFinite(v) ? v : null;
  }

  function fmtCompact(n){
    if(n==null || !Number.isFinite(n)) return '–';
    const abs = Math.abs(n);
    const sign = n < 0 ? '-' : '';
    const units = [{v:1e12,s:'T'},{v:1e9,s:'B'},{v:1e6,s:'M'},{v:1e3,s:'K'}];
    for(const u of units){
      if(abs >= u.v) return sign + (abs/u.v).toFixed(2) + ' ' + u.s;
    }
    return sign + Math.round(abs).toString();
  }

  function computeOnce(){
    const map = headerMap();
    if(!map.row) return;
    const {close, total, shares} = map;
    if(close===-1 || total===-1 || shares===-1) return;

    const tbody = document.getElementById(TBODY_ID);
    if(!tbody) return;
    Array.from(tbody.rows).forEach(tr => {
      const cClose  = tr.children[close];
      const cTotal  = tr.children[total];
      const cShares = tr.children[shares];
      if(!cClose || !cTotal || !cShares) return;

      const vClose  = parseClose(cClose.textContent);
      const vShares = parseShares(cShares.textContent);

      if(vClose!=null && vShares!=null){
        const totalVal = (vClose * vShares) * 1000; // <— moltiplicatore x1000
        cTotal.textContent = fmtCompact(totalVal);
      } else {
        cTotal.textContent = '–';
      }
    });
  }

  function boot(){
    computeOnce();
    let n=0;
    const iv = setInterval(() => {
      computeOnce();
      if(++n > 30) clearInterval(iv);
    }, 500);

    const tbody = document.getElementById(TBODY_ID);
    if(tbody){
      const obs = new MutationObserver(() => computeOnce());
      obs.observe(tbody, {childList:true});
    }
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', boot);
  } else {
    boot();
  }
})();
</script>

<script>
/* === Rate Limit Helper v1.0 (non-invasive) ===
   - Se esistono funzioni di fetch prezzi (getClosePrice/fetchWithFallback/enqueue) le "avvolge" con:
     • Limite globale: 1 richiesta ogni 600ms
     • Retry con backoff (429/503): 300ms, 600ms, 1200ms, 2400ms
     • Cache localStorage 24h per chiave "closepx:v1:TICK|YYYY-MM-DD"
   - Non sposta/rompe nulla; se le funzioni non esistono, non fa niente.
*/
(function(){
  const RATE_MS = 600;
  const MAX_RETRIES = 4;
  const BACKOFFS = [300, 600, 1200, 2400];
  const LS_PREFIX = 'closepx:v1:';
  const TTL_MS = 24*60*60*1000;
  let lastAt = 0;

  function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

  function lsGet(key){
    try{
      const raw = localStorage.getItem(LS_PREFIX + key);
      if(!raw) return null;
      const obj = JSON.parse(raw);
      if(!obj || !obj.t || !('v' in obj)) return null;
      if(Date.now() - obj.t > TTL_MS){ localStorage.removeItem(LS_PREFIX + key); return null; }
      return obj.v;
    }catch(e){ return null; }
  }
  function lsSet(key, val){
    try{ localStorage.setItem(LS_PREFIX + key, JSON.stringify({t:Date.now(), v:val})); }catch(e){}
  }

  function rateGate(){
    const now = Date.now();
    const elapsed = now - lastAt;
    const wait = Math.max(0, RATE_MS - elapsed);
    return sleep(wait).then(()=>{ lastAt = Date.now(); });
  }

  // Wrap only if functions exist
  if(typeof window.getClosePrice === 'function'){
    const _orig_getClosePrice = window.getClosePrice;
    window.getClosePrice = async function(symbol, isoDate){
      const key = `${symbol}|${isoDate}`;

      // localStorage cache first
      const cached = lsGet(key);
      if(cached != null) return cached;

      let attempt = 0, lastErr = null;
      while(attempt <= MAX_RETRIES){
        try{
          await rateGate();
          const val = await _orig_getClosePrice(symbol, isoDate);
          if(val != null){ lsSet(key, val); }
          return val;
        }catch(e){
          lastErr = e;
          // Exponential backoff for 429/503 or generic network errors
          const delay = BACKOFFS[Math.min(attempt, BACKOFFS.length-1)];
          await sleep(delay);
          attempt++;
        }
      }
      if(lastErr) throw lastErr;
      return null;
    };
  }

  // Also wrap fetchWithFallback if present to catch HTTP codes
  if(typeof window.fetchWithFallback === 'function'){
    const _orig_fetchWithFallback = window.fetchWithFallback;
    window.fetchWithFallback = async function(url){
      let attempt = 0;
      while(attempt <= MAX_RETRIES){
        try{
          await rateGate();
          const res = await _orig_fetchWithFallback(url);
          return res;
        }catch(e){
          const delay = BACKOFFS[Math.min(attempt, BACKOFFS.length-1)];
          await sleep(delay);
          attempt++;
        }
      }
      // final try
      return _orig_fetchWithFallback(url);
    };
  }

  // If there's a global enqueue, we can throttle it (optional)
  if(typeof window.enqueue === 'function'){
    const _orig_enqueue = window.enqueue;
    window.enqueue = function(task){
      const wrapped = async () => { await rateGate(); return task(); };
      return _orig_enqueue(wrapped);
    };
  }
})();
</script>
</body>
</html>
